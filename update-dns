#!/bin/bash

if [ $(id -u) -ne 0 ]; then
    sudo="sudo"
fi

$sudo docker ps | tail -n +2 | while read line; do
    cid=$(echo $line | awk '{print $NF}')
    ip=$($sudo docker inspect --format '{{ .NetworkSettings.IPAddress }}' ${cid})
    if [ "x${ip}" != "x" ]; then
	printf "%-20s %s.docker\n" ${ip} ${cid}
	$sudo unbound-control local_data_remove "${cid}.docker." > /dev/null
	$sudo unbound-control local_data "${cid}.docker. 60 IN A ${ip}" > /dev/null
	ptr=$(echo $ip | awk -F . '{print $4"."$3"."$2"."$1".in-addr.arpa."}')
	$sudo unbound-control local_data "${ptr} 60 IN PTR ${cid}.docker."
    else
	# container probably in '--net host' mode
	echo "No IP for ${cid}"
    fi
done


# Add common name for the IP address vulcand listens on
unbound-control local_data "eduid.docker. 60 IN A 172.17.42.1"
