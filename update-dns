#!/bin/bash

. common.sh

export GREP_OPTIONS=""

UNBOUNDIP=127.0.0.1

if [ $(id -u) -ne 0 ]; then
    sudo="sudo"
fi

ttl=60


data=$($sudo docker network inspect --format \
    '{{ range $container := .Containers }} {{ $container.Name }}+{{ $container.IPv4Address }} {{ end }}' \
    $DOCKER_NETWORK)

items=$(echo $data | tr " " "\n")
for item in $items; do
    cid=$(echo $item | cut -d \+ -f 1)
    ip=$(echo $item | cut -d \+ -f 2 | cut -d \/ -f 1)
    if [ "x${ip}" = "x" ]; then
        echo "${cid} - No IP address"
        continue
    fi
    printf "%-20s %s.docker\n" ${ip} ${cid}
    $sudo unbound-control -s ${UNBOUNDIP} local_data_remove "${cid}.docker." > /dev/null
    $sudo unbound-control -s ${UNBOUNDIP} local_data "${cid}.docker. ${ttl} IN A ${ip}" > /dev/null
    ptr=$(echo $ip | awk -F . '{print $4"."$3"."$2"."$1".in-addr.arpa."}')
    $sudo unbound-control -s ${UNBOUNDIP} local_data "${ptr} 60 IN PTR ${cid}.docker."
done

