---
x-common-env-variables: &common-env-variables
  PYTHONPATH: /opt/eduid/sources/:/opt/eduid/src/
  EDUID_CONFIG_YAML: /opt/eduid/config.yaml
  extra_args: --reload

x-common-depends-on: &common-depends-on
  log_cleanup:
    condition: service_completed_successfully

services:

  # This is a one-off job that truncates old logs on startup and ensures correct permissions.
  # Runs as root to: 1) truncate logs, 2) fix ownership to eduid (999:999), 3) set proper permissions.
  log_cleanup:
    image: 'docker.sunet.se/eduid/worker:20250929T082727-staging'
    volumes:
      - eduidlogdata:/var/log/eduid
      - mongodblogdata:/var/log/mongodb
      - htmlnginxlogdata:/var/log/nginx/eduid-html
    entrypoint: >
      sh -c '
      find /var/log/eduid /var/log/mongodb /var/log/nginx -type f -name "*.log" -exec truncate --size 0 {} \; &&
      chown -R 999:999 /var/log/eduid /var/log/mongodb /var/log/nginx &&
      find /var/log/eduid /var/log/mongodb /var/log/nginx -type d -exec chmod 770 {} \; &&
      find /var/log/eduid /var/log/mongodb /var/log/nginx -type f -name "*.log" -exec chmod 640 {} \;
      '


  am:
    image: docker.sunet.se/eduid/worker:20250929T082727-staging
    pull_policy: if_not_present
    restart: always
    networks:
      dev:
    volumes:
      - ../eduid-am/etc:/opt/eduid/eduid-am/etc:ro
      - ../config/config.yaml:/opt/eduid/config.yaml:ro
      - eduidlogdata:/var/log/eduid
      # source volumes
      - ../sources/eduid-backend/src/eduid:/opt/eduid/sources/eduid:ro
      - ../sources/eduid/dev-extra-modules.txt:/opt/eduid/sources/eduid/dev-extra-modules.txt:ro
    environment:
      <<: *common-env-variables
      HOSTNAME: am
      eduid_name: am
      EDUID_CONFIG_NS: /eduid/worker/am
      celery_args: --loglevel DEBUG
      eduid_worker_min_nodes: 2
    depends_on:
      <<: *common-depends-on
      mongodb:
        condition: service_healthy
      redis:
        condition: service_started
      rsyslog:
        condition: service_started

  amapi:
    image: docker.sunet.se/eduid/fastapi:20250929T082727-staging
    restart: on-failure
    networks:
      dev:
        ipv4_address: 172.16.10.215
    expose:
      - 8080
    volumes:
      - ../config/config.yaml:/opt/eduid/config.yaml:ro
      - ../eduid-amapi/etc:/opt/eduid/eduid-amapi/etc:ro
      - eduidlogdata:/var/log/eduid
      # source volumes
      - ../sources/eduid-backend/src/eduid:/opt/eduid/sources/eduid:ro
      - ../sources/eduid/dev-extra-modules.txt:/opt/eduid/sources/eduid/dev-extra-modules.txt:ro
    environment:
      <<: *common-env-variables
      eduid_name: amapi
      HOSTNAME: amapi
      EDUID_CONFIG_NS: /eduid/worker/amapi
      eduid_entrypoint: eduid.workers.amapi.run:api
    depends_on:
      <<: *common-depends-on
      mongodb:
        condition: service_healthy

  authn:
    image: docker.sunet.se/eduid/webapp:20250929T082727-staging
    pull_policy: if_not_present
    networks:
      dev:
    expose:
      - 8080
    volumes:
      - ../eduid-authn/etc:/opt/eduid/etc:ro
      - ../config/config.yaml:/opt/eduid/config.yaml:ro
      - appdata:/opt/eduid/run
      - eduidlogdata:/var/log/eduid
      # source volumes
      - ../sources/eduid-backend/src/eduid:/opt/eduid/sources/eduid:ro
      - ../sources/eduid/dev-extra-modules.txt:/opt/eduid/sources/eduid/dev-extra-modules.txt:ro
    environment:
      <<: *common-env-variables
      HOSTNAME: authn
      eduid_name: authn
      EDUID_CONFIG_NS: /eduid/webapp/authn
    depends_on:
      <<: *common-depends-on
      mongodb:
        condition: service_healthy
      redis:
        condition: service_started
      rsyslog:
        condition: service_started

  auth_server:
    image: docker.sunet.se/sunet/sunet-auth-server:latest
    restart: on-failure
    networks:
      dev:
    expose:
      - 8000
    volumes:
      - ../auth-server/etc:/opt/sunet/auth-server/etc
      - ../config/config.yaml:/opt/eduid/config.yaml:ro
      - eduidlogdata:/var/log/sunet
      # source volumes
      - ../sources/sunet-auth-server/src/auth_server:/opt/eduid/sources/auth_server:ro
    environment:
      <<: *common-env-variables
      PYTHONPATH: /opt/eduid/sources/:/opt/sunet/sunet-auth-server/src/
      HOSTNAME: auth_server
      app_name: auth_server
      config_file: /opt/eduid/config.yaml
      config_ns: /eduid/api/auth_server
      app_entrypoint: auth_server.run:app
    depends_on:
      <<: *common-depends-on
      mongodb:
        condition: service_healthy

  api_haproxy:
    image: 'docker.sunet.se/eduid/haproxy:latest'
    networks:
      dev:
        ipv4_address: 172.16.10.235
    expose:
      - 443
    volumes:
      - ../api-haproxy/etc/haproxy.cfg:/etc/haproxy/haproxy.cfg:ro
      - ../pki/api.pem:/etc/ssl/api.pem
    links:
      - scimapi
      - auth_server
    depends_on:
      <<: *common-depends-on
      scimapi:
        condition: service_started
      auth_server:
        condition: service_started

  bankid:
    image: docker.sunet.se/eduid/webapp:20250929T082727-staging
    pull_policy: if_not_present
    networks:
      dev:
    expose:
      - 8080
    volumes:
      - ../eduid-bankid/etc:/opt/eduid/etc:ro
      - ../config/config.yaml:/opt/eduid/config.yaml:ro
      - appdata:/opt/eduid/run
      - eduidlogdata:/var/log/eduid
      # source volumes
      - ../sources/eduid-backend/src/eduid:/opt/eduid/sources/eduid:ro
      - ../sources/pysaml2:/opt/eduid/src/pysaml2:ro
      - ../sources/eduid/dev-extra-modules.txt:/opt/eduid/sources/eduid/dev-extra-modules.txt:ro
    environment:
      <<: *common-env-variables
      PYTHONPATH: /opt/eduid/sources/:/opt/eduid/src/pysaml2/src:/opt/eduid/src/
      HOSTNAME: bankid
      eduid_name: bankid
      EDUID_CONFIG_NS: /eduid/webapp/bankid
    depends_on:
      <<: *common-depends-on
      am:
        condition: service_healthy
      mongodb:
        condition: service_healthy
      redis:
        condition: service_started
      rsyslog:
        condition: service_started

  bankid_haproxy:
    image: 'docker.sunet.se/eduid/haproxy:latest'
    networks:
      dev:
        ipv4_address: 172.16.10.232
        aliases:
          - bankid.eduid.docker
    expose:
      - 443
    volumes:
      - ../bankid-haproxy/etc/haproxy.cfg:/etc/haproxy/haproxy.cfg:ro
      - ../pki/bankid.pem:/etc/ssl/bankid.pem:ro
    depends_on:
      <<: *common-depends-on
      bankid:
        condition: service_started

  dashboard_haproxy:
    image: 'docker.sunet.se/eduid/haproxy:latest'
    networks:
      dev:
        ipv4_address: 172.16.10.220
    expose:
      - 443
    volumes:
      - ../dashboard-haproxy/etc/haproxy.cfg:/etc/haproxy/haproxy.cfg:ro
      - ../pki/dashboard.pem:/etc/ssl/dashboard.pem
    depends_on:
      <<: *common-depends-on
      authn:
        condition: service_healthy
      html:
        condition: service_healthy
      jsconfig:
        condition: service_healthy
      ladok:
        condition: service_healthy
      letter_proofing:
        condition: service_healthy
      orcid:
        condition: service_healthy
      personal_data:
        condition: service_healthy
      eidas:
        condition: service_healthy
      bankid:
        condition: service_healthy
      freja_eid:
        condition: service_healthy

  eidas:
    image: docker.sunet.se/eduid/webapp:20250929T082727-staging
    pull_policy: if_not_present
    networks:
      dev:
    expose:
      - 8080
    volumes:
      - ../eduid-eidas/etc:/opt/eduid/etc:ro
      - ../config/config.yaml:/opt/eduid/config.yaml:ro
      - appdata:/opt/eduid/run
      - eduidlogdata:/var/log/eduid
      # source volumes
      - ../sources/eduid-backend/src/eduid:/opt/eduid/sources/eduid:ro
      - ../sources/pysaml2:/opt/eduid/src/pysaml2:ro
      - ../sources/eduid/dev-extra-modules.txt:/opt/eduid/sources/eduid/dev-extra-modules.txt:ro
    environment:
      <<: *common-env-variables
      PYTHONPATH: /opt/eduid/sources/:/opt/eduid/src/pysaml2/src:/opt/eduid/src/
      HOSTNAME: eidas
      eduid_name: eidas
      EDUID_CONFIG_NS: /eduid/webapp/eidas
    depends_on:
      <<: *common-depends-on
      am:
        condition: service_healthy
      mongodb:
        condition: service_healthy
      redis:
        condition: service_started
      rsyslog:
        condition: service_started

  eidas_haproxy:
    image: 'docker.sunet.se/eduid/haproxy:latest'
    networks:
      dev:
        ipv4_address: 172.16.10.229
        aliases:
          - eidas.eduid.docker
    expose:
      - 443
    volumes:
      - ../eidas-haproxy/etc/haproxy.cfg:/etc/haproxy/haproxy.cfg:ro
      - ../pki/eidas.pem:/etc/ssl/eidas.pem:ro
    depends_on:
      <<: *common-depends-on
      eidas:
        condition: service_healthy

  email:
    image: docker.sunet.se/eduid/webapp:20250929T082727-staging
    pull_policy: if_not_present
    networks:
      dev:
        ipv4_address: 172.16.10.225
    expose:
      - 8080
    volumes:
      - ../eduid-email/etc:/opt/eduid/etc:ro
      - ../config/config.yaml:/opt/eduid/config.yaml:ro
      - appdata:/opt/eduid/run
      - eduidlogdata:/var/log/eduid
      # source volumes
      - ../sources/eduid-backend/src/eduid:/opt/eduid/sources/eduid:ro
      - ../sources/eduid/dev-extra-modules.txt:/opt/eduid/sources/eduid/dev-extra-modules.txt:ro
    environment:
      <<: *common-env-variables
      HOSTNAME: email
      eduid_name: email
      EDUID_CONFIG_NS: /eduid/webapp/email
    depends_on:
      <<: *common-depends-on
      mongodb:
        condition: service_healthy
      redis:
        condition: service_started
      rsyslog:
        condition: service_started

  html:
    image: docker.sunet.se/eduid/html:20250929T082727-staging
    expose:
      - 80
    dns: 172.16.10.1
    networks:
      dev:
    volumes:
      - ../eduid-html/etc/html.conf:/etc/nginx/sites-enabled/html.conf:ro
      - htmlnginxlogdata:/var/log/nginx/
      # source volumes
      - ../sources/eduid-html:/src/eduid/www:ro
      - ../sources/eduid-html/static:/src/eduid/static:ro
      - ../sources/eduid-front/build:/src/eduid-front:ro
      - ../sources/eduid-managed-accounts/dist:/src/eduid-managed-accounts:ro
    environment:
      HOSTNAME: html
    depends_on:
      <<: *common-depends-on

  html_haproxy:
    image: 'docker.sunet.se/eduid/haproxy:latest'
    networks:
      dev:
        ipv4_address: 172.16.10.230
        aliases:
          - html.eduid.docker
    expose:
      - 443
    volumes:
      - ../html-haproxy/etc/haproxy.cfg:/etc/haproxy/haproxy.cfg:ro
      - ../pki/html.pem:/etc/ssl/html.pem:ro
    depends_on:
      <<: *common-depends-on
      html:
        condition: service_healthy

  managed_accounts_haproxy:
    image: 'docker.sunet.se/eduid/haproxy:latest'
    networks:
      dev:
        ipv4_address: 172.16.10.231
        aliases:
          - managed-accounts.eduid.docker
    expose:
      - 443
    volumes:
      - ../managed-accounts-haproxy/etc/haproxy.cfg:/etc/haproxy/haproxy.cfg:ro
      - ../pki/managed-accounts.pem:/etc/ssl/managed-accounts.pem:ro
    depends_on:
      <<: *common-depends-on
      html:
        condition: service_healthy

  idp:
    image: docker.sunet.se/eduid/webapp:20250929T082727-staging
    pull_policy: if_not_present
    networks:
      dev:
    volumes:
      - ../eduid-idp/etc:/opt/eduid/eduid-idp/etc:ro
      - ../config/config.yaml:/opt/eduid/config.yaml:ro
      - appdata:/opt/eduid/eduid-idp/run
      - eduidlogdata:/var/log/eduid
      # source volumes
      - ../sources/eduid-backend/src/eduid:/opt/eduid/sources/eduid:ro
      - ../sources/pysaml2:/opt/eduid/src/pysaml2:ro
      - ../sources/pyXMLSecurity:/opt/eduid/src/pyXMLSecurity:ro
      - ../sources/eduid/dev-extra-modules.txt:/opt/eduid/sources/eduid/dev-extra-modules.txt:ro
      # profiling
      - ../eduid-idp/profiling:/opt/eduid/eduid-idp/profiling
    environment:
      <<: *common-env-variables
      PYTHONPATH: /opt/eduid/sources/:/opt/eduid/src/pysaml2/src:/opt/eduid/src/pyXMLSecurity/src:/opt/eduid/src/
      HOSTNAME: idp
      eduid_name: idp
      EDUID_CONFIG_NS: /eduid/webapp/idp
      pysaml2_settings: /opt/eduid/eduid-idp/etc/idp_pysaml2_settings.py
      limit_request_line: 8190
    depends_on:
      <<: *common-depends-on
      mongodb:
        condition: service_healthy
      vccs:
        condition: service_healthy
      redis:
        condition: service_started
      rsyslog:
        condition: service_started

  idp_haproxy:
    image: 'docker.sunet.se/eduid/haproxy:latest'
    networks:
      dev:
        ipv4_address: 172.16.10.200
        aliases:
          - idp.eduid.docker
    volumes:
      - ../idp-haproxy/etc/haproxy.cfg:/etc/haproxy/haproxy.cfg:ro
      - ../pki/idp.pem:/etc/ssl/idp.pem:ro
    depends_on:
      <<: *common-depends-on
      html:
        condition: service_healthy
      idp:
        condition: service_healthy
      reset_password:
        condition: service_healthy

  idpproxy:
    image: docker.sunet.se/eduid/satosa_scim:20250929T082727-staging
    restart: on-failure
    networks:
      dev:
    expose:
      - 8000
    volumes:
      - ../eduid-idpproxy/satosa:/opt/eduid/idpproxy/satosa:ro
      - ../eduid-idpproxy/satosa/run:/opt/eduid/idpproxy/satosa/run:rw
      - ../eduid-idpproxy/satosa/metadata:/opt/eduid/idpproxy/satosa/metadata:rw
      - eduidlogdata:/var/log/eduid
      # source volumes
      - ../sources/eduid-backend/src/eduid:/opt/eduid/sources/eduid:ro
      - ../sources/satosa/src/satosa:/opt/eduid/sources/satosa:ro
    environment:
      <<: *common-env-variables
      eduid_name: satosa
      eduid_entrypoint: satosa.wsgi:app
      SATOSA_CONFIG: opt/eduid/idpproxy/satosa/proxy_conf.yaml
      DATA_DIR: /opt/eduid/idpproxy/satosa
      METADATA_DIR: opt/eduid/idpproxy/satosa/metadata
      limit_request_line: 8190
    depends_on:
      <<: *common-depends-on
      mongodb:
        condition: service_healthy
      neo4jdb:
        condition: service_started

  idpproxy_haproxy:
    image: 'docker.sunet.se/eduid/haproxy:latest'
    networks:
      dev:
        ipv4_address: 172.16.10.233
        aliases:
          - idpproxy.eduid.docker
    volumes:
      - ../idpproxy-haproxy/etc/haproxy.cfg:/etc/haproxy/haproxy.cfg:ro
      - ../pki/idpproxy.pem:/etc/ssl/idpproxy.pem:ro
    depends_on:
      <<: *common-depends-on
      idpproxy:
        condition: service_started

  jsconfig:
    image: docker.sunet.se/eduid/webapp:20250929T082727-staging
    pull_policy: if_not_present
    networks:
      dev:
    expose:
      - 8080
    volumes:
      - ../eduid-jsconfig/etc:/opt/eduid/etc:ro
      - ../pki/rootCA.crt:/etc/ssl/rootCA.crt:ro
      - ../config/config.yaml:/opt/eduid/config.yaml:ro
      - appdata:/opt/eduid/run
      - eduidlogdata:/var/log/eduid
      # source volumes
      - ../sources/eduid-backend/src/eduid:/opt/eduid/sources/eduid:ro
      - ../sources/eduid/dev-extra-modules.txt:/opt/eduid/sources/eduid/dev-extra-modules.txt:ro
    environment:
      <<: *common-env-variables
      PYTHONPATH: /opt/eduid/sources/:/opt/eduid/src/
      REQUESTS_CA_BUNDLE: /etc/ssl/rootCA.crt
      HOSTNAME: jsconfig
      eduid_name: jsconfig
      # Can't set EDUID_CONFIG_NS for jsconfig as the value will be used for jsapps also
      # - "EDUID_CONFIG_NS=/eduid/webapp/jsconfig"
    depends_on:
      <<: *common-depends-on
      mongodb:
        condition: service_healthy
      redis:
        condition: service_started
      rsyslog:
        condition: service_started

  ladok:
    image: docker.sunet.se/eduid/webapp:20250929T082727-staging
    pull_policy: if_not_present
    networks:
      dev:
    expose:
      - 8080
    volumes:
      - ../config/config.yaml:/opt/eduid/config.yaml:ro
      - appdata:/opt/eduid/run
      - eduidlogdata:/var/log/eduid
      # source volumes
      - ../sources/eduid-backend/src/eduid:/opt/eduid/sources/eduid:ro
      - ../sources/eduid/dev-extra-modules.txt:/opt/eduid/sources/eduid/dev-extra-modules.txt:ro
    environment:
      <<: *common-env-variables
      HOSTNAME: ladok
      eduid_name: ladok
      EDUID_CONFIG_NS: /eduid/webapp/ladok
    depends_on:
      <<: *common-depends-on
      am:
        condition: service_healthy
      mongodb:
        condition: service_healthy
      redis:
        condition: service_started

  letter_proofing:
    image: docker.sunet.se/eduid/webapp:20250929T082727-staging
    pull_policy: if_not_present
    networks:
      dev:
    expose:
      - 8080
    volumes:
      - ../config/config.yaml:/opt/eduid/config.yaml:ro
      - appdata:/opt/eduid/run
      - eduidlogdata:/var/log/eduid
      # source volumes
      - ../sources/eduid-backend/src/eduid:/opt/eduid/sources/eduid:ro
      - ../sources/eduid/dev-extra-modules.txt:/opt/eduid/sources/eduid/dev-extra-modules.txt:ro
    environment:
      <<: *common-env-variables
      HOSTNAME: letter_proofing
      eduid_name: letter_proofing
      EDUID_CONFIG_NS: /eduid/webapp/letter_proofing
    depends_on:
      <<: *common-depends-on
      am:
        condition: service_healthy
      mongodb:
        condition: service_healthy
      redis:
        condition: service_started
      rsyslog:
        condition: service_started

  maccapi:
    image: docker.sunet.se/eduid/fastapi:20250929T082727-staging
    pull_policy: if_not_present
    restart: on-failure
    networks:
      dev:
    expose:
      - 8080
    volumes:
      - ../eduid-maccapi/etc:/opt/eduid/eduid-maccapi/etc:ro
      - ../config/config.yaml:/opt/eduid/config.yaml:ro
      - eduidlogdata:/var/log/eduid
      # source volumes
      - ../sources/eduid-backend/src/eduid:/opt/eduid/sources/eduid:ro
      - ../sources/eduid/dev-extra-modules.txt:/opt/eduid/sources/eduid/dev-extra-modules.txt:ro
    environment:
      <<: *common-env-variables
      eduid_name: maccapi
      HOSTNAME: maccapi
      EDUID_CONFIG_NS: /eduid/api/maccapi
      eduid_entrypoint: eduid.maccapi.run:api
    depends_on:
      <<: *common-depends-on
      am:
        condition: service_healthy
      mongodb:
        condition: service_healthy
      vccs:
        condition: service_healthy
      redis:
        condition: service_started

  mongodb:
    image: docker.sunet.se/eduid/mongodb
    expose:
      - 27017
    networks:
      dev:
        ipv4_address: 172.16.10.253
    hostname: "mongodb"
    volumes:
      - mongodbdata:/data
      - mongodblogdata:/var/log/mongodb
      - ../mongodb/etc:/opt/eduid/etc:ro
      - ../mongodb/db-scripts:/opt/eduid/db-scripts:ro
    healthcheck:
      test: ["CMD", "mongosh", "localhost/test", "--eval", "quit(db.runCommand({ ismaster: 1 }).ismaster ? 0 : 1)"]
      interval: 40s
      timeout: 30s
      retries: 3
    environment:
      REPLSET: "yes"
    depends_on:
      <<: *common-depends-on

  msg:
    image: docker.sunet.se/eduid/worker:20250929T082727-staging
    pull_policy: if_not_present
    networks:
      dev:
    volumes:
      - ../eduid-msg/etc:/opt/eduid/eduid-msg/etc:ro
      - ../config/config.yaml:/opt/eduid/config.yaml:ro
      - appdata:/opt/eduid/eduid-msg/run
      - eduidlogdata:/var/log/eduid
      # source volumes
      - ../sources/eduid-backend/src/eduid:/opt/eduid/sources/eduid:ro
      - ../sources/eduid/dev-extra-modules.txt:/opt/eduid/sources/eduid/dev-extra-modules.txt:ro
    environment:
      <<: *common-env-variables
      HOSTNAME: msg
      eduid_name: msg
      EDUID_CONFIG_NS: /eduid/worker/msg
      celery_args: --loglevel DEBUG
      eduid_worker_min_nodes: 2
    depends_on:
      <<: *common-depends-on
      mongodb:
        condition: service_healthy
      redis:
        condition: service_started
      rsyslog:
        condition: service_started

  navet_service:
    image: docker.sunet.se/eduid/eduid-navet-service:staging
    pull_policy: if_not_present
    networks:
      dev:
    volumes:
      - ../eduid-navet-service/etc:/opt/eduid/eduid-navet-service/etc:ro
      - ../eduid-navet-service/etc/start.sh:/start.sh:ro
      - ../eduid-navet-service/run:/opt/eduid/eduid-navet-service/run
      - eduidlogdata:/var/log/eduid
    environment:
      navet_keystore_pw: abc123
      navet_truststore_pw: abc123
      navet_keystore_file: /opt/eduid/eduid-navet-service/run/kommun-a.p12
      navet_truststore_file: /opt/eduid/eduid-navet-service/run/truststore.jks
      navet_cert_file: /opt/eduid/eduid-navet-service/etc/kommun-a.crt
      navet_key_file: /opt/eduid/eduid-navet-service/etc/kommun-a.key
      navet_ca_cert_file: /opt/eduid/eduid-navet-service/etc/DigiCertGlobalRootG2.crt.pem
      navet_intermediate_cert_file1: NOT_USED
      navet_intermediate_cert_file2: NOT_USED
      #command: "bash -c 'useradd eduid; cp /opt/eduid/eduid-navet-service/etc/kommun-a.p12 /opt/eduid/eduid-navet-service/etc/kommun-a.p12; cp /opt/eduid/eduid-navet-service/run/truststore.jks /opt/eduid/eduid-navet-service/run/truststore.jks; /start.sh'"
    depends_on:
      <<: *common-depends-on

  neo4jdb:
    image: neo4j:4.4-enterprise
    expose:
      - 7474
      - 7687
    networks:
      dev:
        ipv4_address: 172.16.10.236
    volumes:
      - neo4jdbdata:/data
    environment:
      - "NEO4J_AUTH=neo4j/docker"
      - "NEO4J_ACCEPT_LICENSE_AGREEMENT=yes"
      - "NEO4J_dbms_allow__upgrade=true"
      - "NEO4J_metrics_enabled=false"
    depends_on:
      <<: *common-depends-on

  orcid:
    image: docker.sunet.se/eduid/webapp:20250929T082727-staging
    pull_policy: if_not_present
    networks:
      dev:
    expose:
      - 8080
    volumes:
      - ../eduid-orcid/etc:/opt/eduid/etc:ro
      - ../config/config.yaml:/opt/eduid/config.yaml:ro
      - appdata:/opt/eduid/run
      - eduidlogdata:/var/log/eduid
      # source volumes
      - ../sources/eduid-backend/src/eduid:/opt/eduid/sources/eduid:ro
      - ../sources/eduid/dev-extra-modules.txt:/opt/eduid/sources/eduid/dev-extra-modules.txt:ro
    environment:
      <<: *common-env-variables
      HOSTNAME: orcid
      LOCAL_CFG_FILE: /opt/eduid/etc/oidc_client_creds.yaml
      eduid_name: orcid
      EDUID_CONFIG_NS: /eduid/webapp/orcid
    depends_on:
      <<: *common-depends-on
      am:
        condition: service_healthy
      mongodb:
        condition: service_healthy
      redis:
        condition: service_started
      rsyslog:
        condition: service_started
      turq:
        condition: service_started

  personal_data:
    image: docker.sunet.se/eduid/webapp:20250929T082727-staging
    pull_policy: if_not_present
    networks:
      dev:
        ipv4_address: 172.16.10.224
    expose:
      - 8080
    volumes:
      - ../eduid-personal-data/etc:/opt/eduid/etc:ro
      - ../config/config.yaml:/opt/eduid/config.yaml:ro
      - appdata:/opt/eduid/run
      - eduidlogdata:/var/log/eduid
      # source volumes
      - ../sources/eduid-backend/src/eduid:/opt/eduid/sources/eduid:ro
      - ../sources/eduid/dev-extra-modules.txt:/opt/eduid/sources/eduid/dev-extra-modules.txt:ro
    environment:
      <<: *common-env-variables
      HOSTNAME: personal_data
      eduid_name: personal_data
      EDUID_CONFIG_NS: /eduid/webapp/personal_data
    depends_on:
      <<: *common-depends-on
      am:
        condition: service_healthy
      msg:
        condition: service_healthy
      mongodb:
        condition: service_healthy
      redis:
        condition: service_started
      rsyslog:
        condition: service_started

  py11softhsm:
    image: docker.sunet.se/eduid/py11softhsm:latest
    networks:
      dev:
    expose:
      - 8000
    volumes:
      - ../sources/pyeleven:/opt/eduid/src/pyeleven:ro
      - ../py11softhsm/idp-public-snakeoil.key:/opt/eduid/idp-public-snakeoil.key:ro
      - ../py11softhsm/idp_dev_key_202301.pem:/opt/eduid/idp_dev_key_202301.pem:ro
      - ../py11softhsm/keys.txt:/keys.txt:ro
      # Mount these scripts from the eduid-dockerfiles repo when developing them:
      #- ../sources/eduid-dockerfiles/py11softhsm/import-key.sh:/import-key.sh:ro
      #- ../sources/eduid-dockerfiles/py11softhsm/start.sh:/start.sh:ro
      #- ../sources/eduid-dockerfiles/py11softhsm/healthcheck.sh:/healthcheck.sh:ro
    tmpfs:
      - /var/lib/softhsm  # re-init every time
    environment:
      PYTHONPATH: /opt/eduid/src/pyeleven/src
      ENABLE_PKCS11_SPY: anything
    depends_on:
      <<: *common-depends-on

  queue_mail_worker:
    image: docker.sunet.se/eduid/worker:20250929T082727-staging
    pull_policy: if_not_present
    networks:
      dev:
    volumes:
      - ../config/config.yaml:/opt/eduid/config.yaml:ro
      - eduidlogdata:/var/log/eduid
      # source volumes
      - ../sources/eduid-backend/src/eduid:/opt/eduid/sources/eduid:ro
      - ../sources/eduid/dev-extra-modules.txt:/opt/eduid/sources/eduid/dev-extra-modules.txt:ro
    healthcheck:
      disable: true
    environment:
      <<: *common-env-variables
      HOSTNAME: queue_mail_worker
      eduid_name: queue_mail_worker
      WORKER_NAME: queue_mail_worker_1
      EDUID_CONFIG_NS: /eduid/queue/mail_worker
      NEW_QUEUE: "yes"
      eduid_entrypoint: eduid.queue.workers.mail
    depends_on:
      <<: *common-depends-on
      mongodb:
        condition: service_healthy

  queue_scim_event:
    image: docker.sunet.se/eduid/worker:20250929T082727-staging
    pull_policy: if_not_present
    networks:
      dev:
    volumes:
      - ../config/config.yaml:/opt/eduid/config.yaml:ro
      - eduidlogdata:/var/log/eduid
      # source volumes
      - ../sources/eduid-backend/src/eduid:/opt/eduid/sources/eduid:ro
      - ../sources/eduid/dev-extra-modules.txt:/opt/eduid/sources/eduid/dev-extra-modules.txt:ro
    healthcheck:
      disable: true
    environment:
      <<: *common-env-variables
      HOSTNAME: queue_scim_event_worker
      eduid_name: queue_scim_event_worker
      WORKER_NAME: queue_scim_event_worker_1
      EDUID_CONFIG_NS: /eduid/queue/scim_event_worker
      NEW_QUEUE: "yes"
      eduid_entrypoint: eduid.queue.workers.scim_event
    depends_on:
      <<: *common-depends-on
      mongodb:
        condition: service_healthy

  queue_sink_worker:
    image: docker.sunet.se/eduid/worker:20250929T082727-staging
    networks:
      dev:
    volumes:
      - ../config/config.yaml:/opt/eduid/config.yaml:ro
      - eduidlogdata:/var/log/eduid
      # source volumes
      - ../sources/eduid-backend/src/eduid:/opt/eduid/sources/eduid:ro
      - ../sources/eduid/dev-extra-modules.txt:/opt/eduid/sources/eduid/dev-extra-modules.txt:ro
    healthcheck:
      disable: true
    environment:
      <<: *common-env-variables
      HOSTNAME: queue_sink_worker
      eduid_name: queue_sink_worker
      WORKER_NAME: queue_sink_worker_1
      EDUID_CONFIG_NS: /eduid/queue/sink_worker
      NEW_QUEUE: "yes"
      eduid_entrypoint: eduid.queue.workers.sink
    depends_on:
      <<: *common-depends-on
      mongodb:
        condition: service_healthy

  redis:
    image: docker.sunet.se/eduid/redis
    expose:
      - 6379
    networks:
      dev:
        ipv4_address: 172.16.10.252
    volumes:
      - ../redis/etc:/etc/redis
      - redisdata:/data
    depends_on:
      <<: *common-depends-on

  reset_password:
    image: docker.sunet.se/eduid/webapp:20250929T082727-staging
    pull_policy: if_not_present
    networks:
      dev:
        ipv4_address: 172.16.10.213
    expose:
      - 8080
    volumes:
      - ../eduid-reset-password/etc:/opt/eduid/etc:ro
      - ../config/config.yaml:/opt/eduid/config.yaml:ro
      - appdata:/opt/eduid/run
      - eduidlogdata:/var/log/eduid
      # source volumes
      - ../sources/eduid-backend/src/eduid:/opt/eduid/sources/eduid:ro
      - ../sources/eduid/dev-extra-modules.txt:/opt/eduid/sources/eduid/dev-extra-modules.txt:ro
    environment:
      <<: *common-env-variables
      HOSTNAME: reset_password
      eduid_name: reset_password
      EDUID_CONFIG_NS: /eduid/webapp/reset_password
    depends_on:
      <<: *common-depends-on
      am:
        condition: service_healthy
      msg:
        condition: service_healthy
      vccs:
        condition: service_healthy
      mongodb:
        condition: service_healthy
      redis:
        condition: service_started
      rsyslog:
        condition: service_started

  rsyslog:
    image: docker.sunet.se/eduid/rsyslog
    expose:
      - 514
    networks:
      dev:
    volumes:
      - rsyslogdata:/var/log/eduid
    depends_on:
      <<: *common-depends-on

  scimapi:
    image: docker.sunet.se/eduid/fastapi:20250929T082727-staging
    pull_policy: if_not_present
    restart: on-failure
    networks:
      dev:
    expose:
      - 8080
    volumes:
      - ../config/config.yaml:/opt/eduid/config.yaml:ro
      - ../eduid-scimapi/etc:/opt/eduid/eduid-scimapi/etc:ro
      - eduidlogdata:/var/log/eduid
      # source volumes
      - ../sources/eduid-backend/src/eduid:/opt/eduid/sources/eduid:ro
      - ../sources/eduid/dev-extra-modules.txt:/opt/eduid/sources/eduid/dev-extra-modules.txt:ro
    environment:
      <<: *common-env-variables
      eduid_name: scimapi
      HOSTNAME: scimapi
      EDUID_CONFIG_NS: /eduid/api/scimapi
      eduid_entrypoint: eduid.scimapi.run:api
    depends_on:
      <<: *common-depends-on
      mongodb:
        condition: service_healthy
      neo4jdb:
        condition: service_started

  security:
    image: docker.sunet.se/eduid/webapp:20250929T082727-staging
    pull_policy: if_not_present
    networks:
      dev:
        ipv4_address: 172.16.10.227
    expose:
      - 8080
    volumes:
      - ../eduid-security/etc:/opt/eduid/etc:ro
      - ../config/config.yaml:/opt/eduid/config.yaml:ro
      - appdata:/opt/eduid/run
      - eduidlogdata:/var/log/eduid
      # source volumes
      - ../sources/eduid-backend/src/eduid:/opt/eduid/sources/eduid:ro
      - ../sources/python-fido-mds/src/fido_mds:/opt/eduid/sources/fido_mds:ro
      - ../sources/eduid/dev-extra-modules.txt:/opt/eduid/sources/eduid/dev-extra-modules.txt:ro
    environment:
      <<: *common-env-variables
      HOSTNAME: security
      eduid_name: security
      EDUID_CONFIG_NS: /eduid/webapp/security
    depends_on:
      <<: *common-depends-on
      am:
        condition: service_healthy
      msg:
        condition: service_healthy
      mongodb:
        condition: service_healthy
      vccs:
        condition: service_healthy
      redis:
        condition: service_started
      rsyslog:
        condition: service_started

  signup:
    image: docker.sunet.se/eduid/webapp:20250929T082727-staging
    pull_policy: if_not_present
    networks:
      dev:
        ipv4_address: 172.16.10.211
    expose:
      - 8080
    volumes:
      - ../eduid-signup/etc:/opt/eduid/etc
      - ../config/config.yaml:/opt/eduid/config.yaml:ro
      - ../pip_install_webapp.sh:/pip_install_webapp.sh
      - appdata:/opt/eduid/run
      - eduidlogdata:/var/log/eduid
      # source volumes
      - ../sources/eduid-backend/src/eduid:/opt/eduid/sources/eduid:ro
      - ../sources/eduid/dev-extra-modules.txt:/opt/eduid/sources/eduid/dev-extra-modules.txt:ro
    environment:
      <<: *common-env-variables
      HOSTNAME: signup
      eduid_name: signup
      EDUID_CONFIG_NS: /eduid/webapp/signup
    depends_on:
      <<: *common-depends-on
      am:
        condition: service_healthy
      msg:
        condition: service_healthy
      vccs:
        condition: service_healthy
      mongodb:
        condition: service_healthy
      redis:
        condition: service_started
      rsyslog:
        condition: service_started

  signup_haproxy:
    image: 'docker.sunet.se/eduid/haproxy:latest'
    networks:
      dev:
        ipv4_address: 172.16.10.210
    expose:
      - 443
    volumes:
      - ../signup-haproxy/etc/haproxy.cfg:/etc/haproxy/haproxy.cfg:ro
      - ../pki/signup.pem:/etc/ssl/signup.pem:ro
    depends_on:
      <<: *common-depends-on
      html:
        condition: service_healthy
      jsconfig:
        condition: service_healthy
      signup:
        condition: service_healthy

  support:
    image: docker.sunet.se/eduid/webapp:20250929T082727-staging
    pull_policy: if_not_present
    networks:
      dev:
    expose:
      - 8080
    volumes:
      - ../config/config.yaml:/opt/eduid/config.yaml:ro
      - appdata:/opt/eduid/run
      - eduidlogdata:/var/log/eduid
      # source volumes
      - ../sources/eduid-backend/src/eduid:/opt/eduid/sources/eduid:ro
      - ../sources/eduid/dev-extra-modules.txt:/opt/eduid/sources/eduid/dev-extra-modules.txt:ro
    environment:
      <<: *common-env-variables
      HOSTNAME: support
      eduid_name: support
      EDUID_CONFIG_NS: /eduid/webapp/support
      FLASK_ENV: debug
    depends_on:
      <<: *common-depends-on
      mongodb:
        condition: service_healthy
      redis:
        condition: service_started
      rsyslog:
        condition: service_started

  support_haproxy:
    image: 'docker.sunet.se/eduid/haproxy:latest'
    networks:
      dev:
        ipv4_address: 172.16.10.223
    expose:
      - 443
    volumes:
      - ../support-haproxy/etc/haproxy.cfg:/etc/haproxy/haproxy.cfg:ro
      - ../pki/support.pem:/etc/ssl/support.pem
    links:
      - support
    depends_on:
      <<: *common-depends-on
      support:
        condition: service_healthy

  freja_eid:
    image: docker.sunet.se/eduid/webapp:20250929T082727-staging
    pull_policy: if_not_present
    networks:
      dev:
    expose:
      - 8080
    volumes:
      - ../config/config.yaml:/opt/eduid/config.yaml:ro
      - ../pip_install_webapp.sh:/pip_install_webapp.sh
      - appdata:/opt/eduid/run
      - eduidlogdata:/var/log/eduid
      # source volumes
      - ../sources/eduid-backend/src/eduid:/opt/eduid/sources/eduid:ro
      - ../sources/eduid/dev-extra-modules.txt:/opt/eduid/sources/eduid/dev-extra-modules.txt:ro
    environment:
      <<: *common-env-variables
      HOSTNAME: freja_eid
      eduid_name: freja_eid
      EDUID_CONFIG_NS: /eduid/webapp/freja_eid
    depends_on:
      <<: *common-depends-on
      am:
        condition: service_healthy
      mongodb:
        condition: service_healthy
      redis:
        condition: service_started
      rsyslog:
        condition: service_started

  turq:
    image: docker.sunet.se/eduid/turq
    networks:
      dev:
        ipv4_address: 172.16.10.250
    depends_on:
      <<: *common-depends-on

  job_runner_fre:
    image: docker.sunet.se/eduid/fastapi:20250929T082727-staging
    networks:
      dev:
    volumes:
      - ../config/config.yaml:/opt/eduid/config.yaml
      - eduidlogdata:/var/log/eduid
      # source volumes
      - ../sources/eduid-backend/src/eduid:/opt/eduid/sources/eduid
      - ../sources/eduid/dev-extra-modules.txt:/opt/eduid/sources/eduid/dev-extra-modules.txt:ro
    environment:
      <<: *common-env-variables
      HOSTNAME: job_runner_fre
      eduid_name: job_runner_fre
      EDUID_CONFIG_NS: /eduid/worker/job_runner
      eduid_entrypoint: eduid.workers.job_runner.run:app
      WORKER_NAME: job_runner_fre
      worker_threads: 1
      workers: 1
    depends_on:
      <<: *common-depends-on
      am:
        condition: service_healthy
      msg:
        condition: service_healthy
      mongodb:
        condition: service_healthy

  job_runner_tug:
    image: docker.sunet.se/eduid/fastapi:20250929T082727-staging
    networks:
      dev:
    volumes:
      - ../config/config.yaml:/opt/eduid/config.yaml
      - eduidlogdata:/var/log/eduid
      # source volumes
      - ../sources/eduid-backend/src/eduid:/opt/eduid/sources/eduid
      - ../sources/eduid/dev-extra-modules.txt:/opt/eduid/sources/eduid/dev-extra-modules.txt:ro
    environment:
      <<: *common-env-variables
      HOSTNAME: job_runner_tug
      eduid_name: job_runner_tug
      EDUID_CONFIG_NS: /eduid/worker/job_runner
      eduid_entrypoint: eduid.workers.job_runner.run:app
      WORKER_NAME: job_runner_tug
      worker_threads: 1
      workers: 1
    depends_on:
      <<: *common-depends-on
      am:
        condition: service_healthy
      msg:
        condition: service_healthy
      mongodb:
        condition: service_healthy

  vccs:
    image: docker.sunet.se/eduid/fastapi:20250929T082727-staging
    pull_policy: if_not_present
    restart: on-failure
    networks:
      dev:
        ipv4_address: 172.16.10.238
    expose:
      - 8080
    volumes:
      - ../vccs:/opt/eduid/vccs:ro
      - ../config/config.yaml:/opt/eduid/config.yaml:ro
      - eduidlogdata:/var/log/eduid
      # source volumes
      - ../sources/eduid-backend/src/eduid:/opt/eduid/sources/eduid:ro
      - ../sources/eduid/dev-extra-modules.txt:/opt/eduid/sources/eduid/dev-extra-modules.txt:ro
    environment:
      <<: *common-env-variables
      eduid_name: vccs
      EDUID_CONFIG_NS: /eduid/api/vccs_local
      eduid_entrypoint: eduid.vccs.server.run:app
    depends_on:
      <<: *common-depends-on
      mongodb:
        condition: service_healthy


volumes:
  appdata:
    name: appdata
  eduidlogdata:
    name: eduidlogdata
  mongodbdata:
    name: mongodbdata
  mongodblogdata:
    name: mongodblogdata
  neo4jdbdata:
    name: neo4jdbdata
  redisdata:
    name: redisdata
  rsyslogdata:
    name: rsyslogdata
  softhsmdata:
    name: softhsmdata
  htmlnginxlogdata:
    name: htmlnginxlogdata


networks:
  dev:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: br-eduid
    ipam:
      driver: default
      config:
        - subnet: 172.16.10.0/24
