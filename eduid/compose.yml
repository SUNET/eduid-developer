---
version: '3.4'
services:

  actions2:
    image: docker.sunet.se/eduid/webapp:20210427T122545-staging
    networks:
      dev:
    expose:
      - 8080
    volumes:
      - ../eduid-actions2/etc:/opt/eduid/etc:ro
      - ../config/config.yaml:/opt/eduid/config.yaml:ro
      - appdata:/opt/eduid/run
      - eduidlogdata:/var/log/eduid
      # source volumes
      - ../sources/eduid-backend/src/eduid:/opt/eduid/sources/eduid:ro
    environment:
      - "PYTHONPATH=/opt/eduid/sources/:/opt/eduid/src/"
      - "HOSTNAME=actions2"
      - "eduid_name=actions2"
      - "EDUID_CONFIG_NS=/eduid/webapp/actions2"
      - "EDUID_CONFIG_YAML=/opt/eduid/config.yaml"
      - "eduid_entrypoint=eduid.webapp.actions.run:app"
    depends_on:
      - mongodb
      - redis
      - rsyslog
    extra_hosts:
      - "dashboard.eduid.docker:172.16.10.220"

  am:
    image: docker.sunet.se/eduid/worker:20210427T122545-staging
    networks:
      dev:
    volumes:
      - ../eduid-am/etc:/opt/eduid/eduid-am/etc:ro
      - ../config/config.yaml:/opt/eduid/config.yaml:ro
      - eduidlogdata:/var/log/eduid
      # source volumes
      - ../sources/eduid-backend/src/eduid:/opt/eduid/sources/eduid:ro
    environment:
      - "PYTHONPATH=/opt/eduid/sources/:/opt/eduid/src/"
      - "HOSTNAME=am"
      - "eduid_name=am"
      - "EDUID_CONFIG_NS=/eduid/worker/am"
      - "EDUID_CONFIG_YAML=/opt/eduid/config.yaml"
      - "celery_args=--loglevel DEBUG"
    depends_on:
      - mongodb
      - redis
      - rsyslog

  authn:
    image: docker.sunet.se/eduid/webapp:20210427T122545-staging
    networks:
      dev:
    expose:
      - 8080
    volumes:
      - ../eduid-authn/etc:/opt/eduid/etc:ro
      - appdata:/opt/eduid/run
      - eduidlogdata:/var/log/eduid
      - ../config/config.yaml:/opt/eduid/config.yaml:ro
      # source volumes
      - ../sources/eduid-backend/src/eduid:/opt/eduid/sources/eduid:ro
    environment:
      - "PYTHONPATH=/opt/eduid/sources/:/opt/eduid/src/"
      - "HOSTNAME=authn"
      - "eduid_name=authn"
      - "EDUID_CONFIG_NS=/eduid/webapp/authn"
      - "EDUID_CONFIG_YAML=/opt/eduid/config.yaml"
    depends_on:
      - mongodb
      - redis
      - rsyslog

  dashboard_haproxy:
    image: 'docker.sunet.se/eduid/haproxy:latest'
    networks:
      dev:
        ipv4_address: 172.16.10.220
    volumes:
      - ../dashboard-haproxy/etc/haproxy.cfg:/etc/haproxy/haproxy.cfg:ro
      - ../pki/dashboard.pem:/etc/ssl/dashboard.pem
      - /dev/log:/dev/log
    links:
      - authn
      - html
      - jsconfig
      - letter_proofing
      - lookup_mobile_proofing
      - oidc_proofing
      - orcid
      - personal_data
    depends_on:
      - authn
      - html
      - jsconfig
      - letter_proofing
      - lookup_mobile_proofing
      - oidc_proofing
      - personal_data

  eidas:
    image: docker.sunet.se/eduid/webapp:20210427T122545-staging
    networks:
      dev:
    expose:
      - 8080
    volumes:
      - ../eduid-eidas/etc:/opt/eduid/etc:ro
      - ../config/config.yaml:/opt/eduid/config.yaml:ro
      - appdata:/opt/eduid/run
      - eduidlogdata:/var/log/eduid
      # source volumes
      - ../sources/eduid-backend/src/eduid:/opt/eduid/sources/eduid:ro
    environment:
      - "PYTHONPATH=/opt/eduid/sources/:/opt/eduid/src/"
      - "HOSTNAME=eidas"
      - "eduid_name=eidas"
      - "EDUID_CONFIG_NS=/eduid/webapp/eidas"
      - "EDUID_CONFIG_YAML=/opt/eduid/config.yaml"
    depends_on:
      - am
      - mongodb
      - redis
      - rsyslog

  eidas_haproxy:
    image: 'docker.sunet.se/eduid/haproxy:latest'
    networks:
      dev:
        ipv4_address: 172.16.10.229
        aliases:
          - eidas.eduid.docker
    volumes:
      - ../eidas-haproxy/etc/haproxy.cfg:/etc/haproxy/haproxy.cfg:ro
      - ../pki/eidas.pem:/etc/ssl/eidas.pem:ro
      - /dev/log:/dev/log
    depends_on:
      - eidas

  email:
    image: docker.sunet.se/eduid/webapp:20210427T122545-staging
    networks:
      dev:
        ipv4_address: 172.16.10.225
    expose:
      - 8080
    volumes:
      - ../eduid-email/etc:/opt/eduid/etc:ro
      - ../config/config.yaml:/opt/eduid/config.yaml:ro
      - appdata:/opt/eduid/run
      - eduidlogdata:/var/log/eduid
      # source volumes
      - ../sources/eduid-backend/src/eduid:/opt/eduid/sources/eduid:ro
    environment:
      - "PYTHONPATH=/opt/eduid/sources/:/opt/eduid/src/"
      - "HOSTNAME=email"
      - "eduid_name=email"
      - "EDUID_CONFIG_NS=/eduid/webapp/email"
      - "EDUID_CONFIG_YAML=/opt/eduid/config.yaml"
    depends_on:
      - redis
      - mongodb

  group_management:
    image: docker.sunet.se/eduid/webapp:20210427T122545-staging
    restart: on-failure
    networks:
      dev:
    expose:
      - 8080
    volumes:
      - ../eduid-group-management/etc:/opt/eduid/etc
      - ../config/config.yaml:/opt/eduid/config.yaml:ro
      - appdata:/opt/eduid/run
      - eduidlogdata:/var/log/eduid
      # source volumes
      - ../sources/eduid-backend/src/eduid:/opt/eduid/sources/eduid:ro
    environment:
      - "PYTHONPATH=/opt/eduid/sources/:/opt/eduid/src/"
      - "HOSTNAME=group_management"
      - "eduid_name=group_management"
      - "EDUID_CONFIG_NS=/eduid/webapp/group_management"
      - "EDUID_CONFIG_YAML=/opt/eduid/config.yaml"
    depends_on:
      - mongodb
      - redis
      - rsyslog

  html:
    image: docker.sunet.se/eduid/eduid-html:latest
    expose:
      - 80
    dns: 172.16.10.1
    networks:
      dev:
        ipv4_address: 172.16.10.231
    volumes:
      # If you don't build JS bundles locally, leave html.conf out (and also sources/eduid-front/build below)
      - ../eduid-html/etc/html.conf:/etc/nginx/sites-enabled/html.conf:ro
      # source volumes
      - ../sources/eduid-html:/src/eduid/www:ro
      - ../sources/eduid-html/static:/src/eduid/static:ro
      - ../sources/eduid-front/build:/src/eduid/front-build:ro
    environment:
      - "HOSTNAME=html"

  html_haproxy:
    image: 'docker.sunet.se/eduid/haproxy:latest'
    networks:
      dev:
        ipv4_address: 172.16.10.230
        aliases:
          - html.eduid.docker
    volumes:
      - ../html-haproxy/etc/haproxy.cfg:/etc/haproxy/haproxy.cfg:ro
      - ../pki/html.pem:/etc/ssl/html.pem:ro
      - /dev/log:/dev/log
    depends_on:
      - html

  idp:
    image: docker.sunet.se/eduid/webapp:20210427T122545-staging
    networks:
      dev:
    volumes:
      - ../eduid-idp/etc:/opt/eduid/eduid-idp/etc:ro
      - ../config/config.yaml:/opt/eduid/config.yaml:ro
      - appdata:/opt/eduid/eduid-idp/run
      - eduidlogdata:/var/log/eduid
      # source volumes
      - ../sources/eduid-backend/src/eduid:/opt/eduid/sources/eduid:ro
      - ../sources/pysaml2:/opt/eduid/src/pysaml2:ro
      - ../sources/pyXMLSecurity:/opt/eduid/src/pyXMLSecurity:ro
    environment:
      - "PYTHONPATH=/opt/eduid/sources/:/opt/eduid/src/pysaml2/src:/opt/eduid/src/pyXMLSecurity/src:/opt/eduid/src/"
      - "HOSTNAME=idp"
      - "eduid_name=idp"
      - "EDUID_CONFIG_NS=/eduid/webapp/idp"
      - "EDUID_CONFIG_YAML=/opt/eduid/config.yaml"
      - "pysaml2_settings=/opt/eduid/eduid-idp/etc/idp_pysaml2_settings.py"
    depends_on:
      - mongodb
      - redis
      - rsyslog
      - vccs

  idp_haproxy:
    image: 'docker.sunet.se/eduid/haproxy:latest'
    networks:
      dev:
        ipv4_address: 172.16.10.200
        aliases:
          - idp.eduid.docker
    volumes:
      - ../idp-haproxy/etc/haproxy.cfg:/etc/haproxy/haproxy.cfg:ro
      - ../pki/idp.pem:/etc/ssl/idp.pem:ro
      - /dev/log:/dev/log
    depends_on:
      - actions2
      - html
      - idp

  jsconfig:
    image: docker.sunet.se/eduid/webapp:20210427T122545-staging
    networks:
      dev:
    expose:
      - 8080
    volumes:
      - ../eduid-jsconfig/etc:/opt/eduid/etc:ro
      - ../pki/rootCA.crt:/etc/ssl/rootCA.crt:ro
      - ../config/config.yaml:/opt/eduid/config.yaml:ro
      - appdata:/opt/eduid/run
      - eduidlogdata:/var/log/eduid
      # source volumes
      - ../sources/eduid-backend/src/eduid:/opt/eduid/sources/eduid:ro
    environment:
      - "PYTHONPATH=/opt/eduid/sources/:/opt/eduid/src/"
      - "REQUESTS_CA_BUNDLE=/etc/ssl/rootCA.crt"
      - "HOSTNAME=jsconfig"
      - "eduid_name=jsconfig"
      # Can't set EDUID_CONFIG_NS for jsconfig as the value will be used for jsapps also
      #- "EDUID_CONFIG_NS=/eduid/webapp/jsconfig"
      - "EDUID_CONFIG_YAML=/opt/eduid/config.yaml"
    depends_on:
      - mongodb
      - redis
      - rsyslog

  letter_proofing:
    image: docker.sunet.se/eduid/webapp:20210427T122545-staging
    networks:
      dev:
    expose:
      - 8080
    volumes:
      - ../config/config.yaml:/opt/eduid/config.yaml:ro
      - appdata:/opt/eduid/run
      - eduidlogdata:/var/log/eduid
      # source volumes
      - ../sources/eduid-backend/src/eduid:/opt/eduid/sources/eduid:ro
    environment:
      - "PYTHONPATH=/opt/eduid/sources/:/opt/eduid/src/"
      - "HOSTNAME=letter_proofing"
      - "eduid_name=letter_proofing"
      - "EDUID_CONFIG_NS=/eduid/webapp/letter_proofing"
      - "EDUID_CONFIG_YAML=/opt/eduid/config.yaml"
    depends_on:
      - am
      - mongodb
      - redis
      - rsyslog

  login_haproxy:
    image: 'docker.sunet.se/eduid/haproxy:latest'
    networks:
      dev:
        ipv4_address: 172.16.10.212
    volumes:
      - ../login-haproxy/etc/haproxy.cfg:/etc/haproxy/haproxy.cfg:ro
      - ../pki/login.pem:/etc/ssl/login.pem:ro
      - /dev/log:/dev/log
    depends_on:
      - html
      - jsconfig
      - reset_password

  lookup-mobile:
    image: docker.sunet.se/eduid/worker:20210427T122545-staging
    networks:
      dev:
    volumes:
      - ../eduid-lookup-mobile/etc:/opt/eduid/eduid-lookup-mobile/etc:ro
      - ../config/config.yaml:/opt/eduid/config.yaml:ro
      - appdata:/opt/eduid/eduid-lookup-mobile/run
      - eduidlogdata:/var/log/eduid
      # source volumes
      - ../sources/eduid-backend/src/eduid:/opt/eduid/sources/eduid:ro
    environment:
      - "PYTHONPATH=/opt/eduid/sources/:/opt/eduid/src/"
      - "HOSTNAME=lookup_mobile"
      - "eduid_name=lookup_mobile"
      - "EDUID_CONFIG_NS=/eduid/worker/lookup_mobile"
      - "EDUID_CONFIG_YAML=/opt/eduid/config.yaml"
      - "celery_args=--loglevel DEBUG"
    depends_on:
      - mongodb
      - redis
      - rsyslog

  lookup_mobile_proofing:
    image: docker.sunet.se/eduid/webapp:20210427T122545-staging
    networks:
      dev:
    expose:
      - 8080
    volumes:
      - ../config/config.yaml:/opt/eduid/config.yaml:ro
      - appdata:/opt/eduid/run
      - eduidlogdata:/var/log/eduid
      # source volumes
      - ../sources/eduid-backend/src/eduid:/opt/eduid/sources/eduid:ro
    environment:
      - "PYTHONPATH=/opt/eduid/sources/:/opt/eduid/src/"
      - "HOSTNAME=lookup_mobile_proofing"
      - "eduid_name=lookup_mobile_proofing"
      - "EDUID_CONFIG_NS=/eduid/webapp/lookup_mobile_proofing"
      - "EDUID_CONFIG_YAML=/opt/eduid/config.yaml"
    depends_on:
      - am
      - mongodb
      - redis
      - turq

  mongodb:
    image: docker.sunet.se/eduid/mongodb
    expose:
      - 27017
    networks:
      dev:
        ipv4_address: 172.16.10.253
    volumes:
      - mongodbdata:/data
      - ../mongodb/etc:/opt/eduid/etc:ro
      - ../mongodb/db-scripts:/opt/eduid/db-scripts:ro

  msg:
    image: docker.sunet.se/eduid/worker:20210427T122545-staging
    networks:
      dev:
    volumes:
      - ../eduid-msg/etc:/opt/eduid/eduid-msg/etc:ro
      - ../config/config.yaml:/opt/eduid/config.yaml:ro
      - appdata:/opt/eduid/eduid-msg/run
      - eduidlogdata:/var/log/eduid
      # source volumes
      - ../sources/eduid-backend/src/eduid:/opt/eduid/sources/eduid:ro
    environment:
      - "PYTHONPATH=/opt/eduid/sources/:/opt/eduid/src/"
      - "HOSTNAME=msg"
      - "eduid_name=msg"
      - "EDUID_CONFIG_NS=/eduid/worker/msg"
      - "EDUID_CONFIG_YAML=/opt/eduid/config.yaml"
      - "celery_args=--loglevel DEBUG"
    depends_on:
      - mongodb
      - redis
      - rsyslog

  neo4jdb:
    image: neo4j:4.0-enterprise
    expose:
      - 7474
      - 7687
    networks:
      dev:
        ipv4_address: 172.16.10.236
    volumes:
      - neo4jdbdata:/data
    environment:
      - "NEO4J_AUTH=neo4j/docker"
      - "NEO4J_ACCEPT_LICENSE_AGREEMENT=yes"

  oidc_proofing:
    image: docker.sunet.se/eduid/webapp:20210427T122545-staging
    networks:
      dev:
    expose:
      - 8080
    volumes:
      - ../config/config.yaml:/opt/eduid/config.yaml:ro
      - appdata:/opt/eduid/run
      - eduidlogdata:/var/log/eduid
      # source volumes
      - ../sources/eduid-backend/src/eduid:/opt/eduid/sources/eduid:ro
    environment:
      - "PYTHONPATH=/opt/eduid/sources/:/opt/eduid/src/"
      - "HOSTNAME=oidc_proofing"
      - "eduid_name=oidc_proofing"
      - "EDUID_CONFIG_NS=/eduid/webapp/oidc_proofing"
      - "EDUID_CONFIG_YAML=/opt/eduid/config.yaml"
    depends_on:
      - am
      - mongodb
      - redis
      - rsyslog
      - turq

  orcid:
    image: docker.sunet.se/eduid/webapp:20210427T122545-staging
    networks:
      dev:
    expose:
      - 8080
    volumes:
      - ../eduid-orcid/etc:/opt/eduid/etc:ro
      - ../config/config.yaml:/opt/eduid/config.yaml:ro
      - appdata:/opt/eduid/run
      - eduidlogdata:/var/log/eduid
      # source volumes
      - ../sources/eduid-backend/src/eduid:/opt/eduid/sources/eduid:ro
    environment:
      - "PYTHONPATH=/opt/eduid/sources/:/opt/eduid/src/"
      - "HOSTNAME=orcid"
      - "LOCAL_CFG_FILE=/opt/eduid/etc/oidc_client_creds.yaml"
      - "eduid_name=orcid"
      - "EDUID_CONFIG_NS=/eduid/webapp/orcid"
      - "EDUID_CONFIG_YAML=/opt/eduid/config.yaml"
    depends_on:
      - am
      - mongodb
      - redis
      - rsyslog
      - turq

  personal_data:
    image: docker.sunet.se/eduid/webapp:20210427T122545-staging
    networks:
      dev:
        ipv4_address: 172.16.10.224
    expose:
      - 8080
    volumes:
      - ../eduid-personal-data/etc:/opt/eduid/etc:ro
      - ../config/config.yaml:/opt/eduid/config.yaml:ro
      - appdata:/opt/eduid/run
      - eduidlogdata:/var/log/eduid
      # source volumes
      - ../sources/eduid-backend/src/eduid:/opt/eduid/sources/eduid:ro
    environment:
      - "PYTHONPATH=/opt/eduid/sources/:/opt/eduid/src/"
      - "HOSTNAME=personal_data"
      - "eduid_name=personal_data"
      - "EDUID_CONFIG_NS=/eduid/webapp/personal_data"
      - "EDUID_CONFIG_YAML=/opt/eduid/config.yaml"
    depends_on:
      - mongodb
      - redis
      - rsyslog

  phone:
    image: docker.sunet.se/eduid/webapp:20210427T122545-staging
    networks:
      dev:
        ipv4_address: 172.16.10.226
    expose:
      - 8080
    volumes:
      - ../eduid-phone/etc:/opt/eduid/etc:ro
      - ../config/config.yaml:/opt/eduid/config.yaml:ro
      - appdata:/opt/eduid/run
      - eduidlogdata:/var/log/eduid
      # source volumes
      - ../sources/eduid-backend/src/eduid:/opt/eduid/sources/eduid:ro
    environment:
      - "PYTHONPATH=/opt/eduid/sources/:/opt/eduid/src/"
      - "HOSTNAME=phone"
      - "eduid_name=phone"
      - "EDUID_CONFIG_NS=/eduid/webapp/phone"
      - "EDUID_CONFIG_YAML=/opt/eduid/config.yaml"
    depends_on:
      - mongodb
      - msg
      - redis
      - rsyslog

  py11softhsm:
    image: docker.sunet.se/eduid/py11softhsm
    networks:
      dev:
    expose:
      - 8000
    volumes:
      - softhsmdata:/var/lib/softhsm
      - /dev/log:/dev/log
      - ../sources/pyeleven:/opt/eduid/src/pyeleven:ro
      - ../py11softhsm/idp-public-snakeoil.key:/opt/eduid/idp-public-snakeoil.key:ro
    environment:
      - "PYTHONPATH=/opt/eduid/src/pyeleven/src"
      - "ENABLE_PKCS11_SPY=anything"
      - "p11softhsm_init_rsa_key=/opt/eduid/idp-public-snakeoil.key"

  redis:
    image: docker.sunet.se/eduid/redis
    expose:
      - 6379
    networks:
      dev:
        ipv4_address: 172.16.10.252
    volumes:
      - ../redis/etc:/etc/redis
      - redisdata:/data

  reset_password:
    image: docker.sunet.se/eduid/webapp:20210427T122545-staging
    networks:
      dev:
        ipv4_address: 172.16.10.213
    expose:
      - 8080
    volumes:
      - ../eduid-reset-password/etc:/opt/eduid/etc:ro
      - ../config/config.yaml:/opt/eduid/config.yaml:ro
      - appdata:/opt/eduid/run
      - eduidlogdata:/var/log/eduid
      # source volumes
      - ../sources/eduid-backend/src/eduid:/opt/eduid/sources/eduid:ro
    environment:
      - "PYTHONPATH=/opt/eduid/sources/:/opt/eduid/src/"
      - "HOSTNAME=reset_password"
      - "eduid_name=reset_password"
      - "EDUID_CONFIG_NS=/eduid/webapp/reset_password"
      - "EDUID_CONFIG_YAML=/opt/eduid/config.yaml"
    depends_on:
      - mongodb
      - msg
      - redis
      - rsyslog
      - vccs

  rsyslog:
    image: docker.sunet.se/eduid/rsyslog
    expose:
      - 514
    networks:
      dev:
    volumes:
      - rsyslogdata:/var/log/eduid

  scimapi:
    image: docker.sunet.se/eduid/falconapi:20210427T122545-staging
    restart: on-failure
    networks:
      dev:
        ipv4_address: 172.16.10.235
    expose:
      - 8000
    volumes:
      - ../config/config.yaml:/opt/eduid/config.yaml:ro
      - eduidlogdata:/var/log/eduid
      # source volumes
      - ../sources/eduid-backend/src/eduid:/opt/eduid/sources/eduid:ro
    environment:
      - "PYTHONPATH=/opt/eduid/sources/:/opt/eduid/src/"
      - "eduid_name=scimapi"
      - "HOSTNAME=scimapi"
      - "EDUID_CONFIG_NS=/eduid/api/scimapi"
      - "EDUID_CONFIG_YAML=/opt/eduid/config.yaml"
      - "eduid_entrypoint=eduid.scimapi.run:api"
    depends_on:
      - mongodb
      - neo4jdb

  security:
    image: docker.sunet.se/eduid/webapp:20210427T122545-staging
    networks:
      dev:
        ipv4_address: 172.16.10.227
    expose:
      - 8080
    volumes:
      - ../eduid-security/etc:/opt/eduid/etc:ro
      - ../config/config.yaml:/opt/eduid/config.yaml:ro
      - appdata:/opt/eduid/run
      - eduidlogdata:/var/log/eduid
      # source volumes
      - ../sources/eduid-backend/src/eduid:/opt/eduid/sources/eduid:ro
    environment:
      - "PYTHONPATH=/opt/eduid/sources/:/opt/eduid/src/"
      - "HOSTNAME=security"
      - "eduid_name=security"
      - "EDUID_CONFIG_NS=/eduid/webapp/security"
      - "EDUID_CONFIG_YAML=/opt/eduid/config.yaml"
    depends_on:
      - mongodb
      - msg
      - redis
      - rsyslog
      - vccs

  signup:
    image: docker.sunet.se/eduid/webapp:20210427T122545-staging
    networks:
      dev:
        ipv4_address: 172.16.10.211
    expose:
      - 8080
    volumes:
      - ../eduid-signup/etc:/opt/eduid/etc
      - ../config/config.yaml:/opt/eduid/config.yaml:ro
      - appdata:/opt/eduid/run
      - eduidlogdata:/var/log/eduid
      # source volumes
      - ../sources/eduid-backend/src/eduid:/opt/eduid/sources/eduid:ro
    environment:
      - "PYTHONPATH=/opt/eduid/sources/:/opt/eduid/src/"
      - "HOSTNAME=signup"
      - "eduid_name=signup"
      - "EDUID_CONFIG_NS=/eduid/webapp/signup"
      - "EDUID_CONFIG_YAML=/opt/eduid/config.yaml"
    depends_on:
      - mongodb
      - msg
      - redis
      - rsyslog
      - vccs

  signup_haproxy:
    image: 'docker.sunet.se/eduid/haproxy:latest'
    networks:
      dev:
        ipv4_address: 172.16.10.210
    volumes:
      - ../signup-haproxy/etc/haproxy.cfg:/etc/haproxy/haproxy.cfg:ro
      - ../pki/signup.pem:/etc/ssl/signup.pem:ro
      - /dev/log:/dev/log
    depends_on:
      - html
      - jsconfig
      - signup

  support:
    image: docker.sunet.se/eduid/webapp:20210427T122545-staging
    networks:
      dev:
    expose:
      - 8080
    volumes:
      - ../config/config.yaml:/opt/eduid/config.yaml:ro
      - appdata:/opt/eduid/run
      - eduidlogdata:/var/log/eduid
      # source volumes
      - ../sources/eduid-backend/src/eduid:/opt/eduid/sources/eduid:ro
    environment:
      - "PYTHONPATH=/opt/eduid/sources/:/opt/eduid/src/"
      - "HOSTNAME=support"
      - "eduid_name=support"
      - "EDUID_CONFIG_NS=/eduid/webapp/support"
      - "EDUID_CONFIG_YAML=/opt/eduid/config.yaml"
    depends_on:
      - mongodb
      - redis
      - rsyslog

  support_haproxy:
    image: 'docker.sunet.se/eduid/haproxy:latest'
    networks:
      dev:
        ipv4_address: 172.16.10.223
    volumes:
      - ../support-haproxy/etc/haproxy.cfg:/etc/haproxy/haproxy.cfg:ro
      - ../pki/support.pem:/etc/ssl/support.pem
      - /dev/log:/dev/log
    links:
      - support
    depends_on:
      - support

  turq:
    image: docker.sunet.se/eduid/turq
    networks:
      dev:
        ipv4_address: 172.16.10.250

  vccs:
    image: docker.sunet.se/eduid/fastapi:20210427T122545-staging
    restart: always
    networks:
      dev:
        ipv4_address: 172.16.10.238
    expose:
      - 8080
    volumes:
      - ../config/config.yaml:/opt/eduid/config.yaml:ro
      - eduidlogdata:/var/log/eduid
      - ../vccs:/opt/eduid/vccs:ro
      - ../sources/eduid-backend/src/eduid:/opt/eduid/sources/eduid:ro
    environment:
      - "PYTHONPATH=/opt/eduid/sources/:/opt/eduid/src/"
      - "eduid_entrypoint=eduid.vccs.server.run:app"
      - "eduid_name=vccs"
      - "EDUID_CONFIG_NS=/eduid/api/vccs"
      - "EDUID_CONFIG_YAML=/opt/eduid/config.yaml"


volumes:
  appdata:
    name: appdata
  eduidlogdata:
    name: eduidlogdata
  mongodbdata:
    name: mongodbdata
  neo4jdbdata:
    name: neo4jdbdata
  redisdata:
    name: redisdata
  rsyslogdata:
    name: rsyslogdata
  softhsmdata:
    name: softhsmdata



networks:
  dev:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: br-eduid
    ipam:
      driver: default
      config:
      - subnet: 172.16.10.0/24
