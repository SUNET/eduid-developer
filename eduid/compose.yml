---
version: '2'
services:

  actions:
    image: docker.sunet.se/eduid/eduid-actions
    #expose:
    #  - 5000
    networks:
      dev:
        ipv4_address: 172.16.10.240
    volumes:
      - ../eduid-actions/etc:/opt/eduid/eduid-actions/etc:ro
      - ../eduid-actions/run:/opt/eduid/eduid-actions/run
      - ../eduid-actions/scripts:/opt/eduid/eduid-actions/scripts:ro
      - ../eduid-actions/log:/var/log/eduid
      # source volumes
      - ../sources/eduid-userdb:/opt/eduid/src/eduid-userdb:ro
      - ../sources/eduid-common:/opt/eduid/src/eduid-common:ro
      - ../sources/eduid-am:/opt/eduid/src/eduid-am:ro
      - ../sources/eduid-actions:/opt/eduid/src/eduid-actions:ro
      - ../sources/eduid_action.tou:/opt/eduid/src/eduid_action.tou:ro
      - ../sources/eduid_action.mfa:/opt/eduid/src/eduid_action.mfa:ro
      - ../sources/eduid-html:/opt/eduid/src/eduid-html:ro
    environment:
      - "PYTHONPATH=/opt/eduid/src/eduid-commmon/src:/opt/eduid/src/eduid-userdb/src:/opt/eduid/src/eduid-am:/opt/eduid/src/eduid_action.tou/src:/opt/eduid/src/eduid_action.mfa/src:/opt/eduid/src/eduid-actions"
      - "HOSTNAME=actions"
    depends_on:
      - mongodb
      - rabbitmq
      - redis
      - rsyslog

  am:
    image: docker.sunet.se/eduid/eduid-am
    networks:
      dev:
    volumes:
      - ../eduid-am/etc:/opt/eduid/eduid-am/etc:ro
      - ../eduid-am/log:/var/log/eduid
      # source volumes
      - ../sources/eduid-am:/opt/eduid/src/eduid-am:ro
      - ../sources/eduid-common:/opt/eduid/src/eduid-common:ro
      - ../sources/eduid-userdb:/opt/eduid/src/eduid-userdb:ro
      - ../sources/eduid-signup-amp:/opt/eduid/src/eduid-signup-amp:ro
      - ../sources/eduid-dashboard-amp:/opt/eduid/src/eduid-dashboard-amp:ro
      - ../sources/eduid-proofing-amp:/opt/eduid/src/eduid-proofing-amp:ro
      - ../sources/eduid-actions:/opt/eduid/src/eduid-actions:ro
      - ../sources/eduid_action.tou:/opt/eduid/src/eduid_action.tou:ro
    environment:
      - "PYTHONPATH=/opt/eduid/src/eduid-am:/opt/eduid/src/eduid-common/src:/opt/eduid/src/eduid-userdb/src:/opt/eduid/src/eduid-signup-amp:/opt/eduid/src/eduid-dashboard-amp:/opt/eduid/src/eduid-proofing-amp:/opt/eduid/src/eduid-actions:/opt/eduid/src/eduid_action.tou"
      - "HOSTNAME=am"
    depends_on:
      - mongodb
      - rabbitmq
      - rsyslog

  api:
    image: docker.sunet.se/eduid/eduid-api
    #expose:
    #  - 5000
    networks:
      dev:
    volumes:
      - ../eduid-api/etc:/opt/eduid/eduid-api/etc:ro
      - ../eduid-api/log:/var/log/eduid
      # source volumes
      - ../sources/eduid-api:/opt/eduid/src/eduid-api:ro
    environment:
      - "PYTHONPATH=/opt/eduid/src/eduid-api/src"
      - "HOSTNAME=api"
    depends_on:
      - mongodb
      - rsyslog

  html:
    image: docker.sunet.se/eduid/eduid-html
    expose:
      - 80
    dns: 172.16.10.1
    networks:
      dev:
        ipv4_address: 172.16.10.230
    volumes:
      - ../eduid-html/log:/var/log/nginx
      - ../eduid-html/etc/html.conf:/etc/nginx/sites-enabled/html.conf
      # source volumes
      - ../sources/eduid-html:/src/eduid/www/
      - ../sources/eduid-html/static:/src/eduid/static/
      - ../sources/eduid-html/react/build:/src/eduid/build/
      - ../sources/eduid-front/build:/src/eduid/signup-build/
      - ../sources/eduid-front/public:/opt/eduid/signup/
    environment:
      - "ENTRY_POINT_URL=http://html.eduid.docker/static/build/index-bundle.dev.js"
      - "SIGNUP_ENTRY_POINT_URL=http://html.eduid.docker/static/signup-build/index-bundle.dev.js"
      - "HOSTNAME=html"

  dashboard_haproxy:
    image: 'docker.sunet.se/library/haproxy:latest'
    networks:
      dev:
        ipv4_address: 172.16.10.220
    volumes:
      - ../dashboard-haproxy/etc/haproxy.cfg:/etc/haproxy/haproxy.cfg:ro
      - /dev/log:/dev/log
    links:
      - html
      - dashboard
      - authn
      - letter_proofing
      - personal_data
      - jsconfig
      - oidc_proofing
      - lookup_mobile_proofing
      - signup2
    depends_on:
      - html
      - dashboard
      - authn
      - letter_proofing
      - personal_data
      - jsconfig
      - oidc_proofing
      - lookup_mobile_proofing
      - signup2

  dashboard:
    image: docker.sunet.se/eduid/eduid-dashboard
    networks:
      dev:
    expose:
      - 8080
    volumes:
      - ../eduid-dashboard/etc:/opt/eduid/eduid-dashboard/etc:ro
      - ../eduid-dashboard/run:/opt/eduid/eduid-dashboard/run
      - ../eduid-dashboard/scripts:/opt/eduid/eduid-dashboard/scripts:ro
      - ../eduid-dashboard/log:/var/log/eduid
      # source volumes
      - ../sources/eduid-dashboard:/opt/eduid/src/eduid-dashboard:ro
      - ../sources/eduid-am:/opt/eduid/src/eduid-am:ro
      - ../sources/eduid_msg:/opt/eduid/src/eduid_msg:ro
      - ../sources/eduid-lookup-mobile:/opt/eduid/src/eduid-lookup-mobile:ro
      - ../sources/eduid-userdb:/opt/eduid/src/eduid-userdb:ro
      - ../sources/eduid-html:/opt/eduid/src/eduid-html:ro
      - ../sources/eduid-common:/opt/eduid/src/eduid-common:ro
    environment:
      - "PYTHONPATH=/opt/eduid/src/eduid-dashboard:/opt/eduid/src/eduid-am:/opt/eduid/src/eduid_msg:/opt/eduid/src/eduid-lookup-mobile:/opt/eduid/src/eduid-userdb/src:/opt/eduid/src/eduid-common/src"
      - "HOSTNAME=dashboard"
    depends_on:
      - mongodb
      - rabbitmq
      - redis
      - idp
      - rsyslog

  authn:
    image: docker.sunet.se/eduid/eduid-authn
    networks:
      dev:
    expose:
      - 8080
    volumes:
      - ../eduid-authn/etc:/opt/eduid/etc
      - ../eduid-authn/run:/opt/eduid/run
      - ../eduid-authn/log:/var/log/eduid
      # source volumes
      - ../sources/eduid-userdb:/opt/eduid/src/eduid-userdb:ro
      - ../sources/eduid-common:/opt/eduid/src/eduid-common:ro
      - ../sources/eduid-webapp:/opt/eduid/src/eduid-webapp:ro
    environment:
      - "PYTHONPATH=/opt/eduid/src/eduid-webapp/src:/opt/eduid/src/eduid-userdb/src:/opt/eduid/src/eduid-common/src:/opt/eduid/eduid-webapp/src"
      - "ETCD_HOST=etcd.eduid_dev"
      - "HOSTNAME=authn"
    depends_on:
      - redis
      - mongodb
      - etcd
      - rsyslog

  letter_proofing:
    image: docker.sunet.se/eduid/eduid-letter-proofing
    networks:
      dev:
    expose:
      - 8080
    volumes:
      - ../eduid-letter-proofing/run:/opt/eduid/run
      - ../eduid-letter-proofing/log:/var/log/eduid
      # source volumes
      - ../sources/eduid-userdb:/opt/eduid/src/eduid-userdb:ro
      - ../sources/eduid-common:/opt/eduid/src/eduid-common:ro
      - ../sources/eduid-webapp:/opt/eduid/src/eduid-webapp:ro
      - ../sources/eduid-am:/opt/eduid/src/eduid-am:ro
      - ../sources/eduid_msg:/opt/eduid/src/eduid_msg:ro
    environment:
      - "PYTHONPATH=/opt/eduid/src/eduid-webapp/src:/opt/eduid/src/eduid-userdb/src:/opt/eduid/src/eduid-common/src:/opt/eduid/eduid-webapp/src:/opt/eduid/eduid-am:/opt/eduid/eduid_msg"
      - "ETCD_HOST=etcd.eduid_dev"
      - "HOSTNAME=letter_proofing"
    depends_on:
      - rabbitmq
      - am
      - redis
      - mongodb
      - etcd
      - rsyslog

  idproofing-letter:
    image: docker.sunet.se/eduid/eduid-idproofing-letter:staging
    #expose:
    #  - 5000
    networks:
      dev:
    volumes:
      - ../eduid-idproofing-letter/etc:/opt/eduid/eduid-idproofing-letter/etc:ro
      - ../eduid-idproofing-letter/run:/opt/eduid/eduid-idproofing-letter/run
      - ../eduid-idproofing-letter/scripts:/opt/eduid/eduid-idproofing-letter/scripts:ro
      - ../eduid-idproofing-letter/log:/var/log/eduid
      # source volumes
      - ../sources/eduid-idproofing-letter:/opt/eduid/src/eduid-idproofing-letter:ro
    environment:
      - "PYTHONPATH=/opt/eduid/src/eduid-idproofing-letter/src"
      - "IDPROOFING_LETTER_SETTINGS=/opt/eduid/eduid-idproofing-letter/etc/dev.py"
      - "HOSTNAME=idproofing_letter"
    depends_on:
      - mongodb
      - rabbitmq

  personal_data:
    image: docker.sunet.se/eduid/eduid-personal-data
    networks:
      dev:
        ipv4_address: 172.16.10.224
    expose:
      - 8080
    volumes:
      - ../eduid-personal-data/etc:/opt/eduid/etc
      - ../eduid-personal-data/run:/opt/eduid/run
      - ../eduid-personal-data/log:/var/log/eduid
      # source volumes
      - ../sources/eduid-userdb:/opt/eduid/src/eduid-userdb:ro
      - ../sources/eduid-common:/opt/eduid/src/eduid-common:ro
      - ../sources/eduid-webapp:/opt/eduid/src/eduid-webapp:ro
      - ../sources/eduid-am:/opt/eduid/src/eduid-am:ro
    environment:
      - "PYTHONPATH=/opt/eduid/src/eduid-webapp/src:/opt/eduid/src/eduid-userdb/src:/opt/eduid/src/eduid-common/src:/opt/eduid/src/eduid-am:/opt/eduid/eduid-webapp/src"
      - "ETCD_HOST=etcd.eduid_dev"
      - "HOSTNAME=personal_data"
    depends_on:
      - redis
      - mongodb
      - etcd
      - rsyslog

  email:
    image: docker.sunet.se/eduid/eduid-email
    networks:
      dev:
        ipv4_address: 172.16.10.225
    expose:
      - 8080
    volumes:
      - ../eduid-email/etc:/opt/eduid/etc
      - ../eduid-email/run:/opt/eduid/run
      - ../eduid-email/log:/var/log/eduid
      # source volumes
      - ../sources/eduid-userdb:/opt/eduid/src/eduid-userdb:ro
      - ../sources/eduid-common:/opt/eduid/src/eduid-common:ro
      - ../sources/eduid-webapp:/opt/eduid/src/eduid-webapp:ro
      - ../sources/eduid-am:/opt/eduid/src/eduid-am:ro
      - ../sources/eduid_msg:/opt/eduid/src/eduid_msg:ro
      - ../sources/flask-babel:/opt/eduid/src/flask-babel:ro
      - ../sources/babel:/opt/eduid/src/babel:ro
    environment:
      - "PYTHONPATH=/opt/eduid/src/eduid-webapp/src:/opt/eduid/src/eduid-userdb/src:/opt/eduid/src/eduid-common/src:/opt/eduid/src/eduid-am:/opt/eduid/src/eduid_msg:/opt/eduid/src/flask-babel:/opt/eduid/src/babel:/opt/eduid/eduid-webapp/src"
      - "ETCD_HOST=etcd.eduid_dev"
      - "HOSTNAME=email"
    depends_on:
      - redis
      - mongodb
      - etcd

  py11softhsm:
    image: docker.sunet.se/eduid/py11softhsm
    networks:
      dev:
    expose:
      - 8000
    volumes:
      - ../py11softhsm/var:/var/lib/softhsm
      - ../py11softhsm/log:/var/log/eduid
      - /dev/log:/dev/log
      - ../sources/pyeleven:/opt/eduid/src/pyeleven:ro
      - ../py11softhsm/idp-public-snakeoil.key:/opt/eduid/idp-public-snakeoil.key:ro
    environment:
      - "PYTHONPATH=/opt/eduid/src/pyeleven/src"
      - "ENABLE_PKCS11_SPY=anything"
      - "p11softhsm_init_rsa_key=/opt/eduid/idp-public-snakeoil.key"

  security:
    image: docker.sunet.se/eduid/eduid-security
    networks:
      dev:
        ipv4_address: 172.16.10.227
    expose:
      - 8080
    volumes:
      - ../eduid-security/etc:/opt/eduid/etc
      - ../eduid-security/run:/opt/eduid/run
      - ../eduid-security/log:/var/log/eduid
      # source volumes
      - ../sources/eduid-userdb:/opt/eduid/src/eduid-userdb:ro
      - ../sources/eduid-common:/opt/eduid/src/eduid-common:ro
      - ../sources/eduid-webapp:/opt/eduid/src/eduid-webapp:ro
      - ../sources/eduid-am:/opt/eduid/src/eduid-am:ro
      - ../sources/eduid_msg:/opt/eduid/src/eduid_msg:ro
      - ../sources/flask-babel:/opt/eduid/src/flask-babel:ro
      - ../sources/babel:/opt/eduid/src/babel:ro
    environment:
      - "PYTHONPATH=/opt/eduid/src/eduid-webapp/src:/opt/eduid/src/eduid-userdb/src:/opt/eduid/src/eduid-common/src:/opt/eduid/src/eduid-am:/opt/eduid/src/eduid_msg:/opt/eduid/src/flask-babel:/opt/eduid/src/babel:/opt/eduid/eduid-webapp/src"
      - "ETCD_HOST=etcd.eduid_dev"
      - "HOSTNAME=security"
    depends_on:
      - redis
      - mongodb
      - etcd
      - msg
      - rsyslog

  phone:
    image: docker.sunet.se/eduid/eduid-phone
    networks:
      dev:
        ipv4_address: 172.16.10.226
    expose:
      - 8080
    volumes:
      - ../eduid-phone/etc:/opt/eduid/etc
      - ../eduid-phone/run:/opt/eduid/run
      - ../eduid-phone/log:/var/log/eduid
      # source volumes
      - ../sources/eduid-userdb:/opt/eduid/src/eduid-userdb:ro
      - ../sources/eduid-common:/opt/eduid/src/eduid-common:ro
      - ../sources/eduid-webapp:/opt/eduid/src/eduid-webapp:ro
      - ../sources/eduid-am:/opt/eduid/src/eduid-am:ro
      - ../sources/eduid_msg:/opt/eduid/src/eduid_msg:ro
      - ../sources/flask-babel:/opt/eduid/src/flask-babel:ro
      - ../sources/babel:/opt/eduid/src/babel:ro
    environment:
      - "PYTHONPATH=/opt/eduid/src/eduid-webapp/src:/opt/eduid/src/eduid-userdb/src:/opt/eduid/src/eduid-common/src:/opt/eduid/src/eduid-am:/opt/eduid/src/eduid_msg:/opt/eduid/src/flask-babel:/opt/eduid/src/babel:/opt/eduid/eduid-webapp/src"
      - "ETCD_HOST=etcd.eduid_dev"
      - "HOSTNAME=phone"
    depends_on:
      - redis
      - mongodb
      - etcd
      - msg
      - rsyslog

  jsconfig:
    image: docker.sunet.se/eduid/eduid-jsconfig
    networks:
      dev:
    expose:
      - 8080
    volumes:
      - ../eduid-jsconfig/etc:/opt/eduid/etc
      - ../eduid-jsconfig/run:/opt/eduid/run
      - ../eduid-jsconfig/log:/var/log/eduid
      # source volumes
      - ../sources/eduid-userdb:/opt/eduid/src/eduid-userdb:ro
      - ../sources/eduid-common:/opt/eduid/src/eduid-common:ro
      - ../sources/eduid-webapp:/opt/eduid/src/eduid-webapp:ro
      - ../sources/eduid-am:/opt/eduid/src/eduid-am:ro
    environment:
      - "PYTHONPATH=/opt/eduid/src/eduid-webapp/src:/opt/eduid/src/eduid-userdb/src:/opt/eduid/src/eduid-common/src:/opt/eduid/src/eduid-am:/opt/eduid/eduid-webapp/src"
      - "ETCD_HOST=etcd.eduid_dev"
      - "HOSTNAME=jsconfig"
    depends_on:
      - redis
      - mongodb
      - etcd
      - rsyslog

  oidc_proofing:
    image: docker.sunet.se/eduid/eduid-oidc-proofing
    networks:
      dev:
    expose:
      - 8080
    volumes:
      - ../eduid-oidc-proofing/run:/opt/eduid/run
      - ../eduid-oidc-proofing/log:/var/log/eduid
      # source volumes
      - ../sources/eduid-userdb:/opt/eduid/src/eduid-userdb:ro
      - ../sources/eduid-common:/opt/eduid/src/eduid-common:ro
      - ../sources/eduid-webapp:/opt/eduid/src/eduid-webapp:ro
    environment:
      - "PYTHONPATH=/opt/eduid/src/eduid-webapp/src:/opt/eduid/src/eduid-userdb/src:/opt/eduid/src/eduid-common/src:/opt/eduid/eduid-webapp/src"
      - "ETCD_HOST=etcd.eduid_dev"
      - "HOSTNAME=oidc_proofing"
    depends_on:
      - etcd
      - mongodb
      - turq
      - rabbitmq
      - am
      - redis
      - rsyslog

  lookup_mobile_proofing:
    image: docker.sunet.se/eduid/eduid-lookup-mobile-proofing
    networks:
      dev:
    expose:
      - 8080
    volumes:
      - ../eduid-lookup-mobile-proofing/run:/opt/eduid/run
      - ../eduid-lookup-mobile-proofing/log:/var/log/eduid
      # source volumes
      - ../sources/eduid-userdb:/opt/eduid/src/eduid-userdb:ro
      - ../sources/eduid-common:/opt/eduid/src/eduid-common:ro
      - ../sources/eduid-webapp:/opt/eduid/src/eduid-webapp:ro
    environment:
      - "PYTHONPATH=/opt/eduid/src/eduid-webapp/src:/opt/eduid/src/eduid-userdb/src:/opt/eduid/src/eduid-common/src:/opt/eduid/eduid-webapp/src"
      - "ETCD_HOST=etcd.eduid_dev"
      - "HOSTNAME=lookup_mobile_proofing"
    depends_on:
      - etcd
      - mongodb
      - turq
      - rabbitmq
      - am
      - redis

  support:
    image: docker.sunet.se/eduid/eduid-support
    networks:
      dev:
        ipv4_address: 172.16.10.223
    volumes:
      - ../eduid-support/run:/opt/eduid/run
      - ../eduid-support/log:/var/log/eduid
      # source volumes
      - ../sources/eduid-userdb:/opt/eduid/src/eduid-userdb:ro
      - ../sources/eduid-common:/opt/eduid/src/eduid-common:ro
      - ../sources/eduid-webapp:/opt/eduid/src/eduid-webapp:ro
    environment:
      - "PYTHONPATH=/opt/eduid/src/eduid-webapp/src:/opt/eduid/src/eduid-userdb/src:/opt/eduid/src/eduid-common/src:/opt/eduid/eduid-webapp/src"
      - "ETCD_HOST=etcd.eduid_dev"
      - "HOSTNAME=support"
    depends_on:
      - redis
      - mongodb
      - etcd
      - rsyslog

  idp:
    image: docker.sunet.se/eduid/eduid-idp:latest
    networks:
      dev:
        ipv4_address: 172.16.10.200
        aliases:
          - idp.eduid.docker
    volumes:
      - ../eduid-idp/etc:/opt/eduid/eduid-idp/etc:ro
      - ../eduid-idp/run:/opt/eduid/eduid-idp/run
      - ../eduid-idp/log:/var/log/eduid
      # source volumes
      - ../sources/eduid-IdP:/opt/eduid/src/eduid-IdP:ro
      - ../sources/eduid-am:/opt/eduid/src/eduid-am:ro
      - ../sources/eduid-userdb:/opt/eduid/src/eduid-userdb:ro
      - ../sources/eduid-common:/opt/eduid/src/eduid-common:ro
      - ../sources/eduid-action.tou:/opt/eduid/src/eduid-action.tou:ro
      - ../sources/pysaml2:/opt/eduid/src/pysaml2:ro
      - ../sources/pyXMLSecurity:/opt/eduid/src/pyXMLSecurity:ro
    environment:
      - "PYTHONPATH=/opt/eduid/src/eduid-IdP/src:/opt/eduid/src/eduid-am:/opt/eduid/src/eduid-common/src:/opt/eduid/src/eduid-userdb/src:/opt/eduid/src/eduid-action.tou/src:/opt/eduid/src/pysaml2/src:/opt/eduid/src/pyXMLSecurity/src"
      - "HOSTNAME=idp"
    depends_on:
      - mongodb
      - redis
      - turq
      - rsyslog

  lookup-mobile:
    image: docker.sunet.se/eduid/eduid-lookup-mobile
    networks:
      dev:
    volumes:
      - ../eduid-lookup-mobile/etc:/opt/eduid/eduid-lookup-mobile/etc:ro
      - ../eduid-lookup-mobile/run:/opt/eduid/eduid-lookup-mobile/run
      - ../eduid-lookup-mobile/log:/var/log/eduid
      # source volumes
      - ../sources/eduid-lookup-mobile:/opt/eduid/src/eduid-lookup-mobile:ro
      - ../sources/eduid-userdb:/opt/eduid/src/eduid-userdb:ro
      - ../sources/eduid-common:/opt/eduid/src/eduid-common:ro
    environment:
      - "PYTHONPATH=/opt/eduid/src/eduid-common/src:/opt/eduid/src/eduid-userdb/src:/opt/eduid/src/eduid-lookup-mobile"
      - "HOSTNAME=lookup_mobile"
    depends_on:
      - mongodb
      - rabbitmq
      - rsyslog

#  mm-service:
#    image: docker.sunet.se/eduid/eduid-mm-service
#    networks:
#      dev:
#    volumes:
#      - ../eduid-mm-service/etc:/opt/eduid/eduid-mm-service/etc:ro
#      - ../eduid-mm-service/log:/var/log/eduid
#      # source volumes
#      - ../sources/eduid-mm-service:/opt/eduid/src/eduid-mm-service:ro
#      - ../sources/eduid-am:/opt/eduid/src/eduid-am:ro
#    environment:
#      - "PYTHONPATH=/opt/eduid/src/eduid-mm-service:/opt/eduid/src/eduid-am"
#      - "mm_truststore_pw=foobar"
#      - "mm_keystore_pw=barfoo"

  msg:
    image: docker.sunet.se/eduid/eduid-msg
    networks:
      dev:
    volumes:
      - ../eduid-msg/etc:/opt/eduid/eduid-msg/etc:ro
      - ../eduid-msg/run:/opt/eduid/eduid-msg/run
      - ../eduid-msg/log:/var/log/eduid
      # source volumes
      - ../sources/eduid_msg:/opt/eduid/src/eduid_msg:ro
      - ../sources/eduid-am:/opt/eduid/src/eduid-am:ro
    environment:
      - "PYTHONPATH=/opt/eduid/src/eduid_msg:/opt/eduid/src/eduid-am"
      - "HOSTNAME=msg"
    depends_on:
      - mongodb
      - rabbitmq
      - rsyslog

  signup:
    image: docker.sunet.se/eduid/eduid-signup
    networks:
      dev:
        ipv4_address: 172.16.10.210
    volumes:
      - ../eduid-signup/etc:/opt/eduid/eduid-signup/etc:ro
      - ../eduid-signup/run:/opt/eduid/eduid-signup/run
      - ../eduid-signup/scripts:/opt/eduid/eduid-signup/scripts:ro
      - ../eduid-signup/log:/var/log/eduid
      # source volumes
      - ../sources/eduid-signup:/opt/eduid/src/eduid-signup:ro
      - ../sources/eduid-am:/opt/eduid/src/eduid-am:ro
      - ../sources/eduid-userdb:/opt/eduid/src/eduid-userdb:ro
      - ../sources/eduid-common:/opt/eduid/src/eduid-common:ro
    environment:
      - "PYTHONPATH=/opt/eduid/src/eduid-signup:/opt/eduid/src/eduid-am:/opt/eduid/src/eduid-userdb/src:/opt/eduid/src/eduid-common/src"
      - "HOSTNAME=signup"
    depends_on:
      - mongodb
      - rabbitmq
      - redis
      - rsyslog

  signup2:
    image: docker.sunet.se/eduid/eduid-signup2
    networks:
      dev:
        ipv4_address: 172.16.10.211
    expose:
      - 8080
    volumes:
      - ../eduid-signup2/etc:/opt/eduid/etc
      - ../eduid-signup2/run:/opt/eduid/run
      - ../eduid-signup2/log:/var/log/eduid
      # source volumes
      - ../sources/eduid-userdb:/opt/eduid/src/eduid-userdb:ro
      - ../sources/eduid-common:/opt/eduid/src/eduid-common:ro
      - ../sources/eduid-webapp:/opt/eduid/src/eduid-webapp:ro
      - ../sources/eduid-am:/opt/eduid/src/eduid-am:ro
      - ../sources/eduid_msg:/opt/eduid/src/eduid_msg:ro
    environment:
      - "PYTHONPATH=/opt/eduid/src/eduid-webapp/src:/opt/eduid/src/eduid-userdb/src:/opt/eduid/src/eduid-common/src:/opt/eduid/src/eduid-am:/opt/eduid/src/eduid_msg"
      - "ETCD_HOST=etcd.eduid_dev"
      - "HOSTNAME=signup2"
    depends_on:
      - redis
      - mongodb
      - etcd
      - msg
      - rabbitmq
      - rsyslog

  etcd:
    image: docker.sunet.se/library/etcd:v2.2.5
    expose:
      - 2379
      - 2380
      - 4001
    networks:
      dev:
        ipv4_address: 172.16.10.254
    command: >-
      -name etcd
      -advertise-client-urls http://172.16.10.254:2379,http://172.16.10.254:4001
      -listen-client-urls http://0.0.0.0:2379,http://0.0.0.0:4001
      -initial-advertise-peer-urls http://172.16.10.254:2380
      -listen-peer-urls http://0.0.0.0:2380
      -initial-cluster-token etcd-cluster-1
      -initial-cluster etcd=http://172.16.10.254:2380
      -initial-cluster-state new
      -data-dir /data
    volumes:
      - ../etcd/data:/data

  mongodb:
    image: docker.sunet.se/eduid/mongodb
    expose:
      - 27017
    networks:
      dev:
        ipv4_address: 172.16.10.253
    volumes:
      - ../mongodb/data:/data
      - ../mongodb/etc:/opt/eduid/etc:ro
      - ../mongodb/db-scripts:/opt/eduid/db-scripts:ro
      - ../mongodb/log:/var/log/mongodb

  oathaead:
    image: docker.sunet.se/eduid/eduid-api
    networks:
      dev:
    volumes:
      - ../eduid-oathaead/etc:/opt/eduid/eduid-oathaead/etc:ro
      - ../eduid-oathaead/run:/opt/eduid/eduid-oathaead/run
      - ../eduid-oathaead/log:/var/log/eduid
      # source volumes
      - ../sources/eduid-api:/opt/eduid/src/eduid-api:ro
    environment:
      - "PYTHONPATH=/opt/eduid/src/eduid-api/src"
      - "eduid_name=eduid-oathaead"
    devices:
      - "/dev/ttyACM0:/dev/ttyACM0"
    depends_on:
      - mongodb
      - rsyslog

  rabbitmq:
    image: docker.sunet.se/eduid/rabbitmq
    networks:
      dev:
        ipv4_address: 172.16.10.251
    volumes:
      - ../rabbitmq/etc:/etc/rabbitmq:ro
      - ../rabbitmq/log:/var/log/rabbitmq

  redis:
    image: docker.sunet.se/eduid/redis
    expose:
      - 6379
    networks:
      dev:
        ipv4_address: 172.16.10.252
    volumes:
      - ../redis/etc:/etc/redis:ro
      - ../redis/log:/var/log/redis
      - ../redis/data:/data

    #  simplereg:
    #image: docker.sunet.se/eduid/simplereg
    #networks:
    #  dev:
    #volumes:
    #  - /var/run/docker.sock:/var/run/docker.sock
    #environment:
    #  - "REGISTRATOR_ETCD=1"
    # - "REGISTRATOR_DEBUG=0"
    # - "ETCD_HOST=etcd.eduid_dev"
    #depends_on:
    #  - etcd

  turq:
    image: docker.sunet.se/eduid/turq
    networks:
      dev:
        ipv4_address: 172.16.10.250

  pypiserver:
    image: docker.sunet.se/eduid/pypiserver
    networks:
      dev:
        ipv4_address: 172.16.10.150

    volumes:
      - ../pypiserver/etc:/opt/eduid/pypiserver/etc:ro
      - ../pypiserver/log:/var/log/pypiserver
      - ../pypiserver/packages:/opt/eduid/pypiserver/packages:ro

  rsyslog:
    image: docker.sunet.se/eduid/rsyslog
    expose:
      - 514
    networks:
      dev:
    volumes:
      - ../rsyslog/log:/var/log/eduid

networks:
  dev:
    driver: bridge
    ipam:
      driver: default
      config:
      - subnet: 172.16.10.0/24
        gateway: 172.16.10.1
