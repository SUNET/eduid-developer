global
    log /dev/log local0

    daemon
    maxconn 256
    #stats socket /tmp/socket
    #server-state-file /tmp/server_state

    #user x
    group www-data

    # Default SSL material locations
    #ca-base /etc/ssl/certs
    #crt-base /etc/ssl/private

    #ssl-default-bind-ciphers ECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:ECDH+3DES:DH+3DES:RSA+AESGCM:RSA+AES:RSA+3DES:!aNULL:!MD5:!DSS
    #ssl-default-bind-options no-sslv3
    #tune.ssl.default-dh-param 2048

defaults
    log global
    mode http
    option httplog
    option dontlognull
    timeout connect 1s
    timeout client 20s
    timeout server 30s
    balance roundrobin

frontend dashboard-http
    bind *:8080
    stats enable
    timeout http-request 10s
    timeout http-keep-alive 4s

    acl is_authn path_beg                  /services/authn/
    acl is_security path_beg               /services/security/
    acl is_letter_proofing path_beg        /services/letter-proofing/
    acl is_oidc_proofing path_beg          /services/oidc-proofing/
    acl is_jsconfig path_beg               /services/jsconfig/
    acl is_lookup_mobile_proofing path_beg /services/lookup-mobile-proofing/
    acl is_pdata path_beg                  /services/personal-data/
    acl is_email path_beg                  /services/email/
    acl is_phone path_beg                  /services/phone/
    acl is_dashboard path_beg              /profile/reset-password/
    acl is_html path_beg                   /profile/
    acl should_redirect path               / OR ""

    http-request redirect location /profile/ if should_redirect
    http-request set-header X-Forwarded-Host %[req.hdr(Host)]

    use_backend authn if is_authn
    use_backend security if is_security
    use_backend letter-proofing if is_letter_proofing
    use_backend oidc-proofing if is_oidc_proofing
    use_backend jsconfig if is_jsconfig
    use_backend lookup-mobile-proofing if is_lookup_mobile_proofing
    use_backend pdata if is_pdata
    use_backend email if is_email
    use_backend phone if is_phone
    acl is_security path_beg /services/security
    use_backend security if is_security
    acl is_html path_beg /profile/
    acl is_html path_beg /static/
    use_backend html if is_html
    use_backend dashboard

backend dashboard
    server dashboard1 eduid_dashboard_1:8080 check

backend letter-proofing
    server letterproofing1 eduid_letter_proofing_1:8080 check

backend oidc-proofing
    server oidcproofing1 eduid_oidc_proofing_1:8080 check

backend jsconfig
    server jsconfig eduid_jsconfig_1:8080 check

backend authn
    cookie SERVERID insert indirect nocache
    server authn eduid_authn_1:8080 check

backend security
    server security eduid_security_1:8080 check

backend lookup-mobile-proofing
    server lookupmobileproofing1 eduid_lookup_mobile_proofing_1:8080 check

backend pdata
    server pdata eduid_personal_data_1:8080 check

backend email
    server email eduid_email_1:8080 check

backend phone
    server phone eduid_phone_1:8080 check

# This backend is only used in eduid-developer
backend html
    server html eduid_html_1:80 check

frontend LB-http
    bind *:9000
    default_backend LB

backend LB
    stats enable
    #stats hide-version
    stats uri /haproxy_stats
