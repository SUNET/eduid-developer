global
    log /dev/log local0

    daemon
    maxconn 256
    #stats socket /tmp/socket
    #server-state-file /tmp/server_state

    #user x
    group www-data

    # Default SSL material locations
    #ca-base /etc/ssl/certs
    #crt-base /etc/ssl/private

    #ssl-default-bind-ciphers ECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:ECDH+3DES:DH+3DES:RSA+AESGCM:RSA+AES:RSA+3DES:!aNULL:!MD5:!DSS
    #ssl-default-bind-options no-sslv3
    #tune.ssl.default-dh-param 2048

defaults
    log global
    mode http
    option httplog
    option dontlognull
    timeout connect 1s
    timeout client 20s
    timeout server 30s
    balance roundrobin

resolvers docker_dns
    parse-resolv-conf
    accepted_payload_size 8192

frontend dashboard-http
    bind *:8080
    stats enable
    timeout http-request 10s
    timeout http-keep-alive 4s

    acl should_redirect path               / OR ""

    # Rewrite cookies to Samesite=None until https://github.com/pallets/werkzeug/pull/1550 is merged and released
    rspirep ^(set-cookie:.*)  \1;\ SameSite=None

    http-request redirect location /profile/ if should_redirect
    http-request set-header X-Forwarded-Host %[req.hdr(Host)]

    use_backend feature_se_leg_on if { path_beg /feature/se-leg }
    use_backend feature_groups_on if { path_beg /feature/groups }
    use_backend feature_beta_opt_in if { path_beg /feature/beta }
    use_backend feature_beta_opt_out if { path_beg /feature/no-beta }
    use_backend authn if { path_beg /services/authn/ }
    use_backend security if { path_beg /services/security/ }
    use_backend letter-proofing if { path_beg /services/letter-proofing/ }
    use_backend oidc-proofing if { path_beg /services/oidc-proofing/ }
    use_backend orcid if { path_beg /services/orcid/ }
    use_backend jsconfig if { path_beg /services/jsconfig/ }
    use_backend lookup-mobile-proofing if { path_beg /services/lookup-mobile-proofing/ }
    use_backend pdata if { path_beg /services/personal-data/ }
    use_backend email if { path_beg /services/email/ }
    use_backend phone if { path_beg /services/phone/ }
    use_backend group-management if { path_beg /services/group-management/ }

    use_backend load_dashboard if { path_beg /profile/ }

# Make browsers load the dashboard app when visiting /profile/
backend load_dashboard
    http-request set-uri http://%[req.hdr(Host)]/services/jsconfig/get-bundle
    http-response set-header Cache-Control no-cache
    server jsconfig eduid_jsconfig_1:8080 check resolvers docker_dns  init-addr none

backend letter-proofing
    server letterproofing1 eduid_letter_proofing_1:8080 check resolvers docker_dns  init-addr none

backend oidc-proofing
    server oidcproofing1 eduid_oidc_proofing_1:8080 check resolvers docker_dns  init-addr none

backend orcid
    server orcid1 eduid_orcid_1:8080 check resolvers docker_dns  init-addr none

backend jsconfig
    server jsconfig eduid_jsconfig_1:8080 check resolvers docker_dns  init-addr none

backend authn
    server authn1 eduid_authn_1:8080 check resolvers docker_dns  init-addr none

backend security
    server security eduid_security_1:8080 check resolvers docker_dns  init-addr none

backend lookup-mobile-proofing
    server lookupmobileproofing1 eduid_lookup_mobile_proofing_1:8080 check resolvers docker_dns  init-addr none

backend pdata
    server pdata eduid_personal_data_1:8080 check resolvers docker_dns  init-addr none

backend email
    server email eduid_email_1:8080 check resolvers docker_dns  init-addr none

backend phone
    server phone eduid_phone_1:8080 check resolvers docker_dns  init-addr none

backend group-management
    server groupmanagement1 eduid_group_management_1:8080 check resolvers docker_dns  init-addr none

backend feature_se_leg_on
    redirect location http://dashboard.eduid.docker:8080 set-cookie show-se-leg=value

backend feature_groups_on
    redirect location http://dashboard.eduid.docker:8080 set-cookie show-groups=value

backend feature_beta_opt_in
    redirect location http://dashboard.eduid.docker:8080 set-cookie bundle-version=beta;Domain=.eduid.docker

backend feature_beta_opt_out
    redirect location http://dashboard.eduid.docker:8080 set-cookie bundle-version=default;Domain=.eduid.docker

frontend LB-http
    bind *:9000
    default_backend LB

backend LB
    stats enable
    #stats hide-version
    stats uri /haproxy_stats
